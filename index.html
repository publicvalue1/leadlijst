<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Public Value — Leadlijst Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
  <style>
    :root{
      --pv-dark:#0f2a2e;--pv-dark-2:#12363a;--pv-mint:#9fd6c3;--pv-mint-2:#7fcab2;
      --pv-green:#5fbfa1;--pv-orange:#e7b65c;--pv-red:#d96b6b;--pv-blue:#6baed6;--pv-purple:#b39ddb;
      --text-main:#ffffff;--text-soft:#cfe6de;--stroke:rgba(255,255,255,.10);
      --shadow:0 16px 48px rgba(0,0,0,.40);--radius:22px;
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text-main);padding:22px;
      background:radial-gradient(1200px 650px at 16% 0%,rgba(127,202,178,.20) 0%,rgba(15,42,46,0) 55%),
      radial-gradient(900px 560px at 70% 10%,rgba(31,88,98,.24) 0%,rgba(15,42,46,0) 60%),var(--pv-dark);min-height:100vh;}
    .wrap{max-width:1600px;margin:0 auto;}
    .loginScreen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:70vh;gap:24px;text-align:center;}
    .loginScreen h2{font-size:28px;font-weight:950;color:var(--pv-mint);}
    .loginScreen p{color:var(--text-soft);font-size:14px;max-width:400px;}
    .loginBtn{padding:14px 28px;font-size:15px;font-weight:900;border-radius:999px;border:2px solid rgba(127,202,178,.5);background:rgba(127,202,178,.15);color:var(--pv-mint);cursor:pointer;transition:all .2s;}
    .loginBtn:hover{background:rgba(127,202,178,.3);transform:scale(1.02);}
    .syncStatus{display:inline-flex;align-items:center;gap:6px;font-size:11px;font-weight:700;letter-spacing:.04em;padding:6px 12px;border-radius:999px;background:rgba(15,42,46,.4);border:1px solid rgba(255,255,255,.08);}
    .syncDot{width:8px;height:8px;border-radius:50%;}
    .syncStatus.online .syncDot{background:#5fbfa1;}
    .syncStatus.syncing .syncDot{background:#e7b65c;animation:pulse .8s infinite;}
    .syncStatus.offline .syncDot{background:#d96b6b;}
    .syncStatus.error .syncDot{background:#d96b6b;}
    @keyframes pulse{0%,100%{opacity:1;}50%{opacity:.3;}}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:24px;flex-wrap:wrap;}
    .brand{display:flex;align-items:center;gap:14px;min-width:280px;}
    .pvLogo{width:86px;height:56px;flex:0 0 auto;display:block;}
    .titleBlock{display:flex;flex-direction:column;gap:4px;}
    .eyebrow{color:var(--text-soft);font-size:12px;letter-spacing:.12em;text-transform:uppercase;opacity:.92;}
    .bigTitle{font-size:32px;font-weight:950;letter-spacing:.2px;line-height:1.0;}
    .subtitle{color:var(--text-soft);font-size:13px;opacity:.92;}
    .headerRight{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end;}
    button{cursor:pointer;padding:10px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(15,42,46,.30);color:var(--text-main);font-weight:850;letter-spacing:.2px;font-size:13px;transition:all .2s;display:inline-flex;align-items:center;gap:6px;}
    button.primary{background:rgba(127,202,178,.20);border-color:rgba(127,202,178,.40);color:var(--pv-mint);}
    button.danger{background:rgba(217,107,107,.15);border-color:rgba(217,107,107,.35);color:var(--pv-red);}
    button:hover{filter:brightness(1.12);}
    .badge{background:rgba(127,202,178,.16);border:1px solid rgba(127,202,178,.35);padding:10px 12px;border-radius:999px;color:var(--pv-mint);font-weight:850;letter-spacing:.2px;white-space:nowrap;box-shadow:0 10px 28px rgba(0,0,0,.20);font-size:13px;}
    .card{background:linear-gradient(180deg,rgba(18,54,58,.92),rgba(18,54,58,.78));border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;overflow:hidden;backdrop-filter:blur(6px);margin-bottom:16px;}
    .topline{height:6px;border-radius:999px;background:linear-gradient(90deg,rgba(159,214,195,.92),rgba(127,202,178,.92),rgba(95,191,161,.92));margin-bottom:16px;opacity:.95;}
    .sectionTitle{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:16px;}
    .sectionTitle h2{margin:0;font-size:14px;letter-spacing:.10em;text-transform:uppercase;font-weight:900;color:var(--pv-mint);}
    .sectionTitle .note{font-size:12px;color:var(--text-soft);opacity:.9;}
    .upload-area{display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px 14px;background:rgba(15,42,46,.30);cursor:pointer;transition:all .2s;font-size:13px;font-weight:600;}
    .upload-area:hover{filter:brightness(1.07);background:rgba(127,202,178,.20);border-color:rgba(127,202,178,.40);color:var(--pv-mint);}
    input[type="file"]{display:none;}
    .kpiRow{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;margin-bottom:16px;}
    .kpiBox{border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:18px 20px;background:linear-gradient(180deg,rgba(15,42,46,.35),rgba(15,42,46,.18));cursor:pointer;transition:all .15s;}
    .kpiBox:hover{background:linear-gradient(180deg,rgba(127,202,178,.12),rgba(15,42,46,.25));border-color:rgba(127,202,178,.25);}
    .kpiLabel{font-size:11px;letter-spacing:.10em;text-transform:uppercase;font-weight:800;color:var(--text-soft);opacity:.9;margin-bottom:8px;}
    .kpiValue{font-size:28px;font-weight:950;line-height:1;font-variant-numeric:tabular-nums;}
    .kpiSub{font-size:12px;color:var(--text-soft);opacity:.9;margin-top:6px;font-variant-numeric:tabular-nums;}
    .chartsGrid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;}
    .chartsGridFull{display:grid;grid-template-columns:1fr;gap:16px;margin-bottom:16px;}
    @media(max-width:960px){.chartsGrid{grid-template-columns:1fr;}}
    .chartBox{min-height:300px;position:relative;}
    .chartBox canvas{max-height:340px;}
    .funnelWrap{display:flex;flex-direction:column;gap:10px;padding:10px 0;}
    .funnelStep{display:flex;align-items:center;gap:14px;cursor:pointer;border-radius:10px;padding:4px 8px;transition:background .15s;}
    .funnelStep:hover{background:rgba(127,202,178,.08);}
    .funnelBar{height:44px;border-radius:10px;display:flex;align-items:center;padding:0 16px;font-weight:800;font-size:14px;min-width:60px;transition:width .6s ease;position:relative;overflow:hidden;}
    .funnelBar::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent 70%,rgba(255,255,255,.06));border-radius:10px;}
    .funnelLabel{font-size:12px;color:var(--text-soft);min-width:180px;white-space:nowrap;}
    .funnelValue{font-size:11px;color:var(--text-soft);opacity:.85;min-width:80px;text-align:right;}
    .timelineWrap{position:relative;padding:16px 0 0;}
    .timelineMonth{display:grid;grid-template-columns:120px 1fr 100px;align-items:center;gap:14px;padding:14px 0;border-bottom:1px solid rgba(255,255,255,.06);cursor:pointer;transition:background .15s;border-radius:10px;margin:0 -8px;padding-left:8px!important;padding-right:8px!important;}
    .timelineMonth:last-child{border-bottom:none;}
    .timelineMonth:hover{background:rgba(127,202,178,.06);}
    .timelineMonthLabel{font-weight:800;font-size:14px;color:var(--pv-mint);}
    .timelineMonthLabel .year{font-size:11px;font-weight:600;color:var(--text-soft);opacity:.7;display:block;}
    .timelineBarOuter{height:36px;background:rgba(255,255,255,.04);border-radius:10px;position:relative;overflow:hidden;}
    .timelineBarInner{height:100%;border-radius:10px;display:flex;align-items:center;padding:0 12px;font-weight:800;font-size:13px;transition:width .6s ease;min-width:0;position:relative;}
    .timelineBarInner.confirmed{background:linear-gradient(90deg,rgba(95,191,161,.6),rgba(127,202,178,.5));color:#fff;}
    .timelineBarInner.pipeline{background:linear-gradient(90deg,rgba(231,182,92,.4),rgba(231,182,92,.25));color:var(--pv-orange);position:absolute;top:0;}
    .timelineBarInner.potential{background:linear-gradient(90deg,rgba(179,157,219,.35),rgba(179,157,219,.2));color:var(--pv-purple);position:absolute;top:0;}
    .timelineLegend{display:flex;gap:16px;margin-bottom:16px;padding-left:4px;}
    .legendItem{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text-soft);}
    .legendToggle{cursor:pointer;padding:6px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.1);transition:all .2s;user-select:none;}
    .legendToggle:hover{background:rgba(255,255,255,.06);}
    .legendToggle.active{background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.2);}
    .legendToggle:not(.active){opacity:.4;}
    .legendDot{width:12px;height:12px;border-radius:4px;}
    .legendDot.confirmed{background:rgba(95,191,161,.6);}
    .legendDot.pipeline{background:rgba(231,182,92,.4);}
    .legendDot.potential{background:rgba(179,157,219,.4);}
    .timelineAmount{text-align:right;font-weight:900;font-size:14px;font-variant-numeric:tabular-nums;}
    .timelineAmount .sub{display:block;font-size:11px;font-weight:600;color:var(--text-soft);opacity:.7;}
    .currentMonth .timelineMonthLabel{color:#fff;}
    .currentMonth{background:rgba(127,202,178,.06)!important;}
    .alertSection{margin-bottom:0;}
    .alertList{display:flex;flex-direction:column;gap:6px;}
    .alertItem{display:flex;align-items:center;gap:12px;padding:10px 14px;border-radius:12px;background:rgba(15,42,46,.3);border:1px solid rgba(255,255,255,.06);transition:all .15s;cursor:pointer;}
    .alertItem:hover{background:rgba(127,202,178,.08);}
    .alertItem.overdue{border-color:rgba(217,107,107,.35);background:rgba(217,107,107,.08);}
    .alertItem.upcoming{border-color:rgba(231,182,92,.3);background:rgba(231,182,92,.06);}
    .alertItem.today{border-color:rgba(107,174,214,.4);background:rgba(107,174,214,.08);}
    .alertDot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
    .alertDot.overdue{background:var(--pv-red);}
    .alertDot.upcoming{background:var(--pv-orange);}
    .alertDot.today{background:var(--pv-blue);}
    .alertName{font-weight:700;font-size:13px;flex:1;}
    .alertMeta{font-size:11px;color:var(--text-soft);text-align:right;white-space:nowrap;}
    .alertBadge{font-size:10px;font-weight:800;padding:3px 8px;border-radius:999px;letter-spacing:.03em;}
    .alertBadge.overdue{background:rgba(217,107,107,.2);color:var(--pv-red);}
    .alertBadge.upcoming{background:rgba(231,182,92,.2);color:var(--pv-orange);}
    .alertBadge.today{background:rgba(107,174,214,.2);color:var(--pv-blue);}
    .filterRow{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;align-items:center;}
    .filterRow label{font-size:12px;color:var(--text-soft);font-weight:700;letter-spacing:.05em;text-transform:uppercase;}
    select,.searchInput{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(15,42,46,.5);color:var(--text-main);font-size:13px;font-weight:600;outline:none;transition:all .2s;}
    select:focus,.searchInput:focus{border-color:rgba(127,202,178,.5);background:rgba(15,42,46,.7);}
    .searchInput{min-width:220px;}
    select{cursor:pointer;-webkit-appearance:none;appearance:none;padding-right:28px;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%239fd6c3' stroke-width='2' fill='none'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;}
    select option{background:#12363a;color:#fff;}
    .tableWrap{overflow-x:auto;margin-top:8px;}
    table{width:100%;border-collapse:collapse;font-size:13px;}
    thead th{padding:10px 12px;text-align:left;font-weight:800;font-size:11px;letter-spacing:.08em;text-transform:uppercase;color:var(--pv-mint);border-bottom:2px solid rgba(127,202,178,.3);white-space:nowrap;position:sticky;top:0;background:rgba(18,54,58,.98);z-index:2;cursor:pointer;user-select:none;}
    thead th:hover{color:#fff;}
    thead th .sortArrow{font-size:10px;margin-left:4px;opacity:.5;}
    thead th.sorted .sortArrow{opacity:1;color:var(--pv-mint);}
    tbody tr{border-bottom:1px solid rgba(255,255,255,.05);transition:background .15s;cursor:pointer;}
    tbody tr:hover{background:rgba(127,202,178,.08);}
    tbody td{padding:10px 12px;vertical-align:top;max-width:220px;}
    .statusPill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:11px;font-weight:700;white-space:nowrap;letter-spacing:.02em;}
    .status-1{background:rgba(107,174,214,.18);color:#6baed6;border:1px solid rgba(107,174,214,.3);}
    .status-2{background:rgba(231,182,92,.18);color:#e7b65c;border:1px solid rgba(231,182,92,.3);}
    .status-3{background:rgba(179,157,219,.18);color:#b39ddb;border:1px solid rgba(179,157,219,.3);}
    .status-4{background:rgba(159,214,195,.18);color:#9fd6c3;border:1px solid rgba(159,214,195,.3);}
    .winloss-win{background:rgba(95,191,161,.18);color:var(--pv-green);border:1px solid rgba(95,191,161,.3);}
    .winloss-loss{background:rgba(217,107,107,.18);color:var(--pv-red);border:1px solid rgba(217,107,107,.3);}
    .modalOverlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;display:none;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(4px);}
    .modalOverlay.active{display:flex;}
    .modal{background:linear-gradient(180deg,#12363a,#0f2a2e);border:1px solid rgba(127,202,178,.2);border-radius:var(--radius);padding:28px;max-width:640px;width:100%;box-shadow:0 32px 80px rgba(0,0,0,.6);max-height:90vh;overflow-y:auto;}
    .modal h3{font-size:18px;font-weight:900;color:var(--pv-mint);margin-bottom:20px;}
    .formGrid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
    .formGroup{display:flex;flex-direction:column;gap:4px;}
    .formGroup.full{grid-column:1/-1;}
    .formGroup label{font-size:11px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--text-soft);}
    .formGroup input,.formGroup select,.formGroup textarea{background:rgba(15,42,46,.6);border:1px solid rgba(255,255,255,.12);border-radius:10px;color:#fff;padding:10px 12px;font-size:13px;font-family:inherit;outline:none;transition:border-color .2s;}
    .formGroup input:focus,.formGroup select:focus,.formGroup textarea:focus{border-color:rgba(127,202,178,.5);}
    .formGroup textarea{resize:vertical;min-height:60px;}
    .modalActions{display:flex;gap:10px;margin-top:20px;justify-content:flex-end;}
    .detailGrid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;}
    .detailField{display:flex;flex-direction:column;gap:2px;}
    .detailField.full{grid-column:1/-1;}
    .detailLabel{font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--text-soft);opacity:.8;}
    .detailValue{font-size:14px;font-weight:600;}
    .detailDivider{grid-column:1/-1;height:1px;background:rgba(255,255,255,.08);margin:4px 0;}
    .monthDetailHeader{display:flex;align-items:center;justify-content:space-between;gap:14px;margin-bottom:20px;padding-bottom:14px;border-bottom:1px solid rgba(255,255,255,.08);flex-wrap:wrap;}
    .monthDetailTotals{display:flex;gap:20px;flex-wrap:wrap;}
    .monthDetailTotal{text-align:center;}
    .monthDetailTotal .val{font-size:22px;font-weight:950;font-variant-numeric:tabular-nums;}
    .monthDetailTotal .lbl{font-size:11px;color:var(--text-soft);letter-spacing:.06em;text-transform:uppercase;font-weight:700;margin-top:2px;}
    .monthDetailTable{width:100%;border-collapse:collapse;font-size:13px;margin-top:8px;}
    .monthDetailTable th{padding:8px 12px;text-align:left;font-weight:800;font-size:11px;letter-spacing:.06em;text-transform:uppercase;color:var(--pv-mint);border-bottom:1px solid rgba(127,202,178,.2);}
    .monthDetailTable td{padding:8px 12px;border-bottom:1px solid rgba(255,255,255,.04);}
    .monthDetailTable tbody tr{cursor:pointer;transition:background .15s;}
    .monthDetailTable tbody tr:hover{background:rgba(127,202,178,.08);}
    .emptyState{text-align:center;padding:60px 20px;}
    .emptyState .emptyIcon{font-size:48px;margin-bottom:16px;opacity:.6;}
    .emptyState h3{font-size:20px;font-weight:900;color:var(--pv-mint);margin-bottom:8px;}
    .emptyState p{color:var(--text-soft);font-size:14px;max-width:400px;margin:0 auto;}
    .toast{position:fixed;bottom:24px;right:24px;background:rgba(18,54,58,.96);border:1px solid rgba(127,202,178,.3);border-radius:14px;padding:14px 20px;font-size:13px;font-weight:700;color:var(--pv-mint);z-index:200;box-shadow:0 12px 40px rgba(0,0,0,.5);transform:translateY(100px);opacity:0;transition:all .3s ease;}
    .toast.show{transform:translateY(0);opacity:1;}
    .modalFilterRow{display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap;}
    .modalFilterToggle{cursor:pointer;padding:6px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.12);font-size:12px;font-weight:700;color:var(--text-soft);transition:all .2s;user-select:none;display:inline-flex;align-items:center;gap:6px;}
    .modalFilterToggle:hover{background:rgba(255,255,255,.06);}
    .modalFilterToggle.active{background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.25);color:#fff;}
    .modalFilterToggle:not(.active){opacity:.45;}
    .modalFilterDot{width:10px;height:10px;border-radius:3px;}
    .partnerPill{cursor:pointer;padding:6px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.10);font-size:12px;font-weight:700;color:var(--text-soft);transition:all .2s;user-select:none;white-space:nowrap;}
    .partnerPill:hover{background:rgba(255,255,255,.06);}
    .partnerPill.active{background:rgba(127,202,178,.15);border-color:rgba(127,202,178,.35);color:var(--pv-mint);}
    .alertItem.expiring{border-color:rgba(179,157,219,.35);background:rgba(179,157,219,.08);}
    .alertDot.expiring{background:var(--pv-purple);}
    .alertBadge.expiring{background:rgba(179,157,219,.2);color:var(--pv-purple);}
    .alertItem.upcominglead{border-color:rgba(107,174,214,.3);background:rgba(107,174,214,.06);}
    .alertDot.upcominglead{background:var(--pv-blue);}
    .alertBadge.upcominglead{background:rgba(107,174,214,.2);color:var(--pv-blue);}
    .alertPartner{font-size:10px;font-weight:700;color:var(--text-soft);opacity:.7;letter-spacing:.03em;}
    .infoBtn{cursor:pointer;font-size:14px;opacity:.5;transition:opacity .2s;font-style:normal;margin-left:2px;}
    .infoBtn:hover{opacity:1;}
    .alertItem.incomplete{border-color:rgba(231,182,92,.3);background:rgba(231,182,92,.06);}
    .alertDot.incomplete{background:var(--pv-orange);}
    .alertBadge.incomplete{background:rgba(231,182,92,.2);color:var(--pv-orange);}
    .infoPopup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(180deg,#12363a,#0f2a2e);border:1px solid rgba(127,202,178,.25);border-radius:16px;padding:24px;max-width:420px;width:90%;z-index:300;box-shadow:0 24px 60px rgba(0,0,0,.6);}
    .infoPopup h4{font-size:15px;font-weight:900;color:var(--pv-mint);margin-bottom:10px;}
    .infoPopup p{font-size:13px;color:var(--text-soft);line-height:1.6;margin-bottom:8px;}
    .infoPopupOverlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:299;backdrop-filter:blur(2px);}
    .collapsed{display:none !important;}
    .arrowUp{transform:rotate(180deg);}
    .winloss-afgerond{background:rgba(127,202,178,.12);color:var(--pv-mint);border:1px solid rgba(127,202,178,.25);}
    ::-webkit-scrollbar{width:6px;height:6px;}
    ::-webkit-scrollbar-track{background:transparent;}
    ::-webkit-scrollbar-thumb{background:rgba(127,202,178,.25);border-radius:999px;}
    @media(max-width:640px){.bigTitle{font-size:24px;}.kpiRow{grid-template-columns:1fr 1fr;}.formGrid{grid-template-columns:1fr;}.funnelLabel{min-width:120px;font-size:11px;}.detailGrid{grid-template-columns:1fr;}.timelineMonth{grid-template-columns:90px 1fr 80px;}}
  </style>
</head>
<body>
<div class="wrap">
  <div id="loginScreen" class="loginScreen">
    <svg class="pvLogo" viewBox="0 0 180 120" style="width:140px;height:90px;"><text x="0" y="48" font-size="44" font-weight="800" fill="var(--pv-mint)">Public</text><text x="0" y="100" font-size="44" font-weight="800" fill="var(--pv-mint)">Value</text><line x1="76" y1="60" x2="92" y2="36" stroke="var(--pv-mint)" stroke-width="8" stroke-linecap="round" opacity=".95"/></svg>
    <h2>Leadlijst Dashboard</h2>
    <p>Log in met je Public Value Microsoft-account om de leadlijst te openen vanuit SharePoint.</p>
    <button class="loginBtn" onclick="doLogin()">&#128272; Inloggen met Microsoft</button>
    <div style="margin-top:12px;"><label class="upload-area" for="fileInput" style="opacity:.7;font-size:12px;"><span>&#128194;</span><span>Of importeer lokaal een Excel</span></label><input type="file" id="fileInput" accept=".xlsx,.xls,.csv" /></div>
    <div id="loginError" style="color:var(--pv-red);font-size:13px;display:none;margin-top:8px;"></div>
  </div>

  <div id="mainApp" style="display:none;">
  <header>
    <div class="brand">
      <svg class="pvLogo" viewBox="0 0 180 120" aria-label="Public Value logo"><rect x="0" y="0" width="180" height="120" fill="none"/><text x="0" y="48" font-size="44" font-weight="800" fill="var(--pv-mint)">Public</text><text x="0" y="100" font-size="44" font-weight="800" fill="var(--pv-mint)">Value</text><line x1="76" y1="60" x2="92" y2="36" stroke="var(--pv-mint)" stroke-width="8" stroke-linecap="round" opacity=".95"/></svg>
      <div class="titleBlock"><span class="eyebrow">Sales Pipeline</span><div class="bigTitle">Leadlijst Dashboard</div><span class="subtitle" id="subtitleDate">Geen data geladen</span></div>
    </div>
    <div class="headerRight">
      <div class="syncStatus offline" id="syncStatus"><div class="syncDot"></div><span id="syncLabel">Offline</span></div>
      <span class="badge" id="badgeCount">—</span>
      <span id="userName" style="font-size:12px;color:var(--text-soft);"></span>
      <button class="primary" onclick="openAddModal()">+ Nieuwe lead</button>
      <button onclick="syncToSharePoint()">&#9729; Opslaan naar SharePoint</button>
      <button onclick="loadFromSharePoint()">&#128260; Vernieuwen</button>
      <button onclick="exportToExcel()">&#11015; Export Excel</button>
    </div>
  </header>

  <div id="emptyState" class="emptyState" style="display:none;"><div class="emptyIcon">&#128202;</div><h3>Geen data gevonden</h3><p>Klik op Vernieuwen om opnieuw te laden vanuit SharePoint.</p></div>

  <div id="dashboardContent" style="display:none;">
    <div class="kpiRow" id="kpiRow">
      <div class="kpiBox" onclick="openKpiModal('opdrachten')"><div class="kpiLabel">Lopende opdrachten <span class="infoBtn" onclick="event.stopPropagation();showInfo('kpi_opdrachten')" title="Info">&#9432;</span></div><div class="kpiValue" id="kpiWins">0</div><div class="kpiSub" id="kpiWinsSub">—</div></div>
      <div class="kpiBox" onclick="openKpiModal('leads')"><div class="kpiLabel">Leads in pipeline <span class="infoBtn" onclick="event.stopPropagation();showInfo('kpi_leads')" title="Info">&#9432;</span></div><div class="kpiValue" id="kpiLeads">0</div><div class="kpiSub" id="kpiLeadsSub">—</div></div>
      <div class="kpiBox" onclick="openKpiModal('bevestigd')"><div class="kpiLabel">Bevestigde omzet <span class="infoBtn" onclick="event.stopPropagation();showInfo('kpi_bevestigd')" title="Info">&#9432;</span></div><div class="kpiValue" id="kpiConfirmed">&#8364; 0</div><div class="kpiSub" id="kpiConfirmedSub">—</div></div>
      <div class="kpiBox" onclick="openKpiModal('gewogen')"><div class="kpiLabel">Gewogen omzet <span class="infoBtn" onclick="event.stopPropagation();showInfo('kpi_gewogen')" title="Info">&#9432;</span></div><div class="kpiValue" id="kpiWeighted">&#8364; 0</div><div class="kpiSub" id="kpiWeightedSub">—</div></div>
      <div class="kpiBox" onclick="openKpiModal('potentieel')"><div class="kpiLabel">Potenti&#235;le omzet <span class="infoBtn" onclick="event.stopPropagation();showInfo('kpi_potentieel')" title="Info">&#9432;</span></div><div class="kpiValue" id="kpiPotential">&#8364; 0</div><div class="kpiSub" id="kpiPotentialSub">—</div></div>
    </div>

    <div class="card alertSection" id="alertCard">
      <div class="topline" style="background:linear-gradient(90deg,rgba(217,107,107,.8),rgba(231,182,92,.8),rgba(107,174,214,.6),rgba(179,157,219,.6));"></div>
      <div class="sectionTitle"><h2>&#9889; Actiepaneel</h2><span class="note" id="alertNote">—</span></div>
      <div class="filterRow" id="partnerFilterRow" style="margin-bottom:12px;gap:6px;">
        <label style="margin-right:4px;">Partner:</label>
      </div>
      <!-- Contact opvolging -->
      <div id="alertContactSection" style="display:none;margin-bottom:14px;">
        <div style="font-size:11px;font-weight:800;letter-spacing:.08em;text-transform:uppercase;color:var(--pv-red);margin-bottom:8px;display:flex;align-items:center;gap:6px;"><span style="width:8px;height:8px;border-radius:50%;background:var(--pv-red);display:inline-block;"></span> Contactmomenten <span class="infoBtn" onclick="event.stopPropagation();showInfo('contact')" title="Info">&#9432;</span></div>
        <div class="alertList" id="alertList"></div>
      </div>
      <!-- Aflopende opdrachten -->
      <div id="alertExpiringSection" style="display:none;margin-bottom:14px;">
        <div style="font-size:11px;font-weight:800;letter-spacing:.08em;text-transform:uppercase;color:var(--pv-purple);margin-bottom:8px;display:flex;align-items:center;gap:6px;"><span style="width:8px;height:8px;border-radius:50%;background:var(--pv-purple);display:inline-block;"></span> Aflopende opdrachten <span class="infoBtn" onclick="event.stopPropagation();showInfo('expiring')" title="Info">&#9432;</span></div>
        <div class="alertList" id="expiringList"></div>
      </div>
      <!-- Naderende leads -->
      <div id="alertUpcomingLeadsSection" style="display:none;margin-bottom:14px;">
        <div style="font-size:11px;font-weight:800;letter-spacing:.08em;text-transform:uppercase;color:var(--pv-blue);margin-bottom:8px;display:flex;align-items:center;gap:6px;"><span style="width:8px;height:8px;border-radius:50%;background:var(--pv-blue);display:inline-block;"></span> Leads — startdatum bereikt of naderend <span class="infoBtn" onclick="event.stopPropagation();showInfo('upcoming')" title="Info">&#9432;</span></div>
        <div class="alertList" id="upcomingLeadsList"></div>
      </div>
      <!-- Onvolledige gegevens -->
      <div id="alertIncompleteSection" style="display:none;margin-bottom:4px;">
        <div style="font-size:11px;font-weight:800;letter-spacing:.08em;text-transform:uppercase;color:var(--pv-orange);margin-bottom:8px;display:flex;align-items:center;gap:6px;"><span style="width:8px;height:8px;border-radius:50%;background:var(--pv-orange);display:inline-block;"></span> Onvolledige gegevens <span class="infoBtn" onclick="event.stopPropagation();showInfo('incomplete')" title="Info">&#9432;</span></div>
        <div class="alertList" id="incompleteList"></div>
      </div>
      <div id="alertEmpty" class="noAlerts" style="display:none;">Geen acties op dit moment.</div>
    </div>

    <div class="chartsGridFull"><div class="card">
      <div class="topline"></div>
      <div class="sectionTitle"><h2>Omzetprognose komende maanden</h2><span class="note">o.b.v. lopende opdrachten &amp; pipeline</span></div>
      <div class="timelineLegend">
        <div class="legendItem legendToggle active" id="toggleConfirmed" onclick="toggleTimelineFilter('confirmed')"><div class="legendDot confirmed"></div> Bevestigd (Win)</div>
        <div class="legendItem legendToggle active" id="togglePipeline" onclick="toggleTimelineFilter('pipeline')"><div class="legendDot pipeline"></div> Pipeline (gewogen)</div>
        <div class="legendItem legendToggle" id="togglePotential" onclick="toggleTimelineFilter('potential')"><div class="legendDot potential"></div> Potentieel (100%)</div>
      </div>
      <div id="timelineWrap" class="timelineWrap"></div>
    </div></div>

    <div class="chartsGrid">
      <div class="card"><div class="topline"></div><div class="sectionTitle"><h2>Sales Funnel</h2><span class="note">Alleen leads (excl. wins)</span></div><div class="funnelWrap" id="funnelWrap"></div></div>
      <div class="card"><div class="topline"></div><div class="sectionTitle"><h2>Leads per Partner</h2><span class="note">Aantal leads in pipeline</span></div><div class="chartBox"><canvas id="partnerLeadsChart"></canvas></div></div>
    </div>
    <div class="chartsGrid">
      <div class="card"><div class="topline"></div><div class="sectionTitle"><h2>Lopende opdrachten per Partner</h2><span class="note">Aantal &amp; omzet</span></div><div class="chartBox"><canvas id="partnerWinsChart"></canvas></div></div>
      <div class="card"><div class="topline"></div><div class="sectionTitle"><h2>Top Klanten — Lopende opdrachten</h2><span class="note">Bevestigde omzet</span></div><div class="chartBox"><canvas id="clientWinsChart"></canvas></div></div>
    </div>
    <div class="chartsGridFull"><div class="card"><div class="topline"></div><div class="sectionTitle"><h2>Top Klanten — Leads in pipeline</h2><span class="note">Potenti&#235;le waarde</span></div><div class="chartBox"><canvas id="clientLeadsChart"></canvas></div></div></div>

    <div class="card">
      <div class="topline" style="background:linear-gradient(90deg,rgba(95,191,161,.8),rgba(127,202,178,.6));"></div>
      <div class="sectionTitle"><h2>Lopende Opdrachten</h2><span class="note" id="tableWinsCount">—</span></div>
      <div class="filterRow"><label>Filter:</label><select id="filterPartnerWins" onchange="renderWinsTable()"><option value="">Alle partners</option></select><input class="searchInput" type="text" id="searchWins" placeholder="&#128269; Zoek klant of opdracht..." oninput="renderWinsTable()" /></div>
      <div class="tableWrap" style="max-height:500px;overflow-y:auto;"><table><thead><tr id="tableWinsHead"></tr></thead><tbody id="tableWinsBody"></tbody></table></div>
    </div>

    <div class="card">
      <div class="topline" style="background:linear-gradient(90deg,rgba(231,182,92,.7),rgba(107,174,214,.5));"></div>
      <div class="sectionTitle"><h2>Leads in Pipeline</h2><span class="note" id="tableLeadsCount">—</span></div>
      <div class="filterRow"><label>Filter:</label>
        <select id="filterStatusLeads" onchange="renderLeadsTable()"><option value="">Alle statussen</option><option value="1 - Ge&#239;dentificeerd">1 - Ge&#239;dentificeerd</option><option value="2 - Besproken">2 - Besproken</option><option value="3 - Offerte uitgebracht in concurrentie">3 - Offerte in concurrentie</option><option value="4 - Offerte uitgebracht zonder concurrentie">4 - Offerte zonder concurrentie</option></select>
        <select id="filterPartnerLeads" onchange="renderLeadsTable()"><option value="">Alle partners</option></select>
        <input class="searchInput" type="text" id="searchLeads" placeholder="&#128269; Zoek klant of opdracht..." oninput="renderLeadsTable()" />
      </div>
      <div class="tableWrap" style="max-height:600px;overflow-y:auto;"><table><thead><tr id="tableLeadsHead"></tr></thead><tbody id="tableLeadsBody"></tbody></table></div>
    </div>

    <!-- AFGERONDE OPDRACHTEN -->
    <div class="card" id="completedCard" style="display:none;">
      <div class="topline" style="background:linear-gradient(90deg,rgba(127,202,178,.5),rgba(159,214,195,.3));"></div>
      <div class="sectionTitle" style="cursor:pointer;" onclick="toggleCollapse('completedContent','completedArrow')"><h2>&#10003; Afgeronde opdrachten</h2><div style="display:flex;align-items:center;gap:10px;"><span class="note" id="completedNote">—</span><span id="completedArrow" style="font-size:14px;transition:transform .2s;">&#9660;</span></div></div>
      <div id="completedContent">
        <div class="tableWrap" style="max-height:350px;overflow-y:auto;"><table><thead><tr><th>Klant</th><th>Opdracht</th><th>Partner</th><th style="text-align:right;">Honorarium</th><th>Periode</th><th>Opmerking</th><th style="width:90px;"></th></tr></thead><tbody id="completedBody"></tbody></table></div>
      </div>
    </div>

    <!-- LOSSES -->
    <div class="card" id="lossCard" style="display:none;">
      <div class="topline" style="background:linear-gradient(90deg,rgba(217,107,107,.7),rgba(217,107,107,.4));"></div>
      <div class="sectionTitle" style="cursor:pointer;" onclick="toggleCollapse('lossContent','lossArrow')"><h2>Losses</h2><div style="display:flex;align-items:center;gap:10px;"><span class="note" id="lossNote">—</span><span id="lossArrow" style="font-size:14px;transition:transform .2s;">&#9660;</span></div></div>
      <div id="lossContent">
        <div class="tableWrap" style="max-height:350px;overflow-y:auto;"><table><thead><tr><th>Klant</th><th>Opdracht</th><th>Partner</th><th>Status</th><th style="text-align:right;">Honorarium</th><th>Opmerking</th><th style="width:90px;"></th></tr></thead><tbody id="lossBody"></tbody></table></div>
      </div>
    </div>
  </div>
  </div>
</div>

<!-- ADD/EDIT MODAL -->
<div class="modalOverlay" id="modalOverlay" onclick="if(event.target===this)closeModal();">
  <div class="modal">
    <h3 id="modalTitle">Nieuwe lead toevoegen</h3>
    <div class="formGrid">
      <div class="formGroup"><label>Klant</label><input type="text" id="fKlant" /></div>
      <div class="formGroup"><label>Partner</label><div style="display:flex;gap:6px;"><select id="fPartner" style="flex:1;"></select><button type="button" onclick="addNewPartner()" style="padding:8px 12px;font-size:12px;white-space:nowrap;" class="primary" title="Nieuwe partner toevoegen">+</button></div></div>
      <div class="formGroup full"><label>Omschrijving opdracht</label><input type="text" id="fOmschrijving" /></div>
      <div class="formGroup"><label>Status</label><select id="fStatus"><option value="1 - Ge&#239;dentificeerd">1 - Ge&#239;dentificeerd</option><option value="2 - Besproken">2 - Besproken</option><option value="3 - Offerte uitgebracht in concurrentie">3 - Offerte in concurrentie</option><option value="4 - Offerte uitgebracht zonder concurrentie">4 - Offerte zonder concurrentie</option></select></div>
      <div class="formGroup"><label>Win / Loss</label><select id="fWinLoss"><option value="">Open</option><option value="Win">Win</option><option value="Afgerond">Afgerond</option><option value="Loss">Loss</option></select></div>
      <div class="formGroup"><label>Startdatum</label><input type="date" id="fStart" /></div>
      <div class="formGroup"><label>Einddatum</label><input type="date" id="fEind" /></div>
      <div class="formGroup"><label>Honorarium (&#8364;)</label><input type="number" id="fHonorarium" min="0" step="100" /></div>
      <div class="formGroup"><label>Bestaande / Nieuwe klant</label><select id="fKlantType"><option value="">—</option><option value="Bestaande klant">Bestaande klant</option><option value="Nieuwe klant">Nieuwe klant</option></select></div>
      <div class="formGroup"><label>Laatste keer contact</label><input type="date" id="fLaatsteContact" /></div>
      <div class="formGroup"><label>Eerstvolgende contact</label><input type="date" id="fVolgendeContact" /></div>
      <div class="formGroup full"><label>Opmerking / follow-up</label><textarea id="fOpmerking"></textarea></div>
    </div>
    <div class="modalActions"><button onclick="closeModal()">Annuleren</button><button class="primary" onclick="saveLead()">&#128190; Opslaan</button><button class="danger" id="btnDeleteLead" onclick="deleteLead()" style="display:none;">&#128465; Verwijderen</button></div>
  </div>
</div>

<!-- LEAD DETAIL MODAL -->
<div class="modalOverlay" id="detailOverlay" onclick="if(event.target===this)closeDetail();">
  <div class="modal" style="max-width:580px;">
    <h3 id="detailTitle">—</h3>
    <div class="detailGrid" id="detailGrid"></div>
    <div class="modalActions"><button onclick="closeDetail()">Sluiten</button><button class="primary" id="detailEditBtn">&#9999;&#65039; Bewerken</button><button class="primary" id="detailWinBtn" style="display:none;background:rgba(95,191,161,.2);border-color:rgba(95,191,161,.4);color:var(--pv-green);">&#10003; Markeer als Win</button><button class="danger" id="detailLossBtn" style="display:none;">&#10007; Markeer als Loss</button></div>
  </div>
</div>

<!-- MONTH DETAIL MODAL -->
<div class="modalOverlay" id="monthModalOverlay" onclick="if(event.target===this)closeMonthModal();">
  <div class="modal" style="max-width:780px;">
    <div class="monthDetailHeader">
      <h3 id="monthModalTitle">—</h3>
      <div class="monthDetailTotals">
        <div class="monthDetailTotal"><div class="val" id="mmConfirmed" style="color:var(--pv-green);">—</div><div class="lbl">Bevestigd</div></div>
        <div class="monthDetailTotal"><div class="val" id="mmPipeline" style="color:var(--pv-orange);">—</div><div class="lbl">Gewogen</div></div>
        <div class="monthDetailTotal"><div class="val" id="mmPotential" style="color:var(--pv-purple);">—</div><div class="lbl">Potentieel</div></div>
        <div class="monthDetailTotal"><div class="val" id="mmTotal">—</div><div class="lbl">Totaal</div></div>
      </div>
    </div>
    <div class="modalFilterRow" id="monthFilterRow">
      <div class="modalFilterToggle active" id="mmToggleConfirmed" onclick="toggleMonthFilter('confirmed')"><div class="modalFilterDot" style="background:rgba(95,191,161,.6);"></div> Bevestigd (Win)</div>
      <div class="modalFilterToggle active" id="mmTogglePipeline" onclick="toggleMonthFilter('pipeline')"><div class="modalFilterDot" style="background:rgba(231,182,92,.5);"></div> Pipeline (gewogen)</div>
      <div class="modalFilterToggle" id="mmTogglePotential" onclick="toggleMonthFilter('potential')"><div class="modalFilterDot" style="background:rgba(179,157,219,.4);"></div> Potentieel (100%)</div>
    </div>
    <div style="max-height:400px;overflow-y:auto;"><table class="monthDetailTable"><thead><tr><th>Klant</th><th>Opdracht</th><th>Status</th><th style="text-align:right;">Omzet (maand)</th></tr></thead><tbody id="monthModalBody"></tbody></table></div>
    <div class="modalActions" style="margin-top:16px;"><button onclick="closeMonthModal()">Sluiten</button></div>
  </div>
</div>

<!-- KPI DETAIL MODAL -->
<div class="modalOverlay" id="kpiModalOverlay" onclick="if(event.target===this)closeKpiModal();">
  <div class="modal" style="max-width:780px;">
    <div class="monthDetailHeader"><h3 id="kpiModalTitle">—</h3><div class="monthDetailTotals"><div class="monthDetailTotal"><div class="val" id="kmTotal">—</div><div class="lbl" id="kmTotalLabel">Totaal</div></div><div class="monthDetailTotal"><div class="val" id="kmCount">—</div><div class="lbl">Aantal</div></div></div></div>
    <div style="max-height:400px;overflow-y:auto;"><table class="monthDetailTable"><thead><tr id="kpiModalHead"></tr></thead><tbody id="kpiModalBody"></tbody></table></div>
    <div class="modalActions" style="margin-top:16px;"><button onclick="closeKpiModal()">Sluiten</button></div>
  </div>
</div>

<!-- CHART DETAIL MODAL -->
<div class="modalOverlay" id="chartDetailOverlay" onclick="if(event.target===this)closeChartDetail();">
  <div class="modal" style="max-width:780px;">
    <div class="monthDetailHeader"><h3 id="chartDetailTitle">—</h3><div class="monthDetailTotals"><div class="monthDetailTotal"><div class="val" id="cdTotal">—</div><div class="lbl" id="cdTotalLabel">Omzet</div></div><div class="monthDetailTotal"><div class="val" id="cdCount">—</div><div class="lbl">Aantal</div></div></div></div>
    <div style="max-height:400px;overflow-y:auto;"><table class="monthDetailTable"><thead><tr id="chartDetailHead"></tr></thead><tbody id="chartDetailBody"></tbody></table></div>
    <div class="modalActions" style="margin-top:16px;"><button onclick="closeChartDetail()">Sluiten</button></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
let leads=[];let editIndex=-1;let showConfirmed=true;let showPipeline=true;let showPotential=false;let cachedMonths=[];
let mmShowConfirmed=true;let mmShowPipeline=true;let mmShowPotential=false;let currentMonthModalIdx=-1;
const PARTNERS_DEFAULT=[];
const STATUS_COLORS={'1 - Geïdentificeerd':{bg:'rgba(107,174,214,.55)',text:'#6baed6'},'2 - Besproken':{bg:'rgba(231,182,92,.55)',text:'#e7b65c'},'3 - Offerte uitgebracht in concurrentie':{bg:'rgba(179,157,219,.55)',text:'#b39ddb'},'4 - Offerte uitgebracht zonder concurrentie':{bg:'rgba(159,214,195,.55)',text:'#9fd6c3'}};
const STATUS_WINKANS={'1 - Geïdentificeerd':.10,'2 - Besproken':.25,'3 - Offerte uitgebracht in concurrentie':.40,'4 - Offerte uitgebracht zonder concurrentie':.70};
const STATUS_SHORT={'1 - Geïdentificeerd':'1 - Geïdentificeerd','2 - Besproken':'2 - Besproken','3 - Offerte uitgebracht in concurrentie':'3 - Offerte in concurrentie','4 - Offerte uitgebracht zonder concurrentie':'4 - Offerte zonder concurrentie'};
const MONTH_NAMES=['Jan','Feb','Mrt','Apr','Mei','Jun','Jul','Aug','Sep','Okt','Nov','Dec'];
const COLORS=['#9fd6c3','#7fcab2','#5fbfa1','#e7b65c','#6baed6','#b39ddb','#d96b6b','#e0a060','#80cbc4','#a5d6a7'];
const TABLE_WINS_COLS=[{key:'klant',label:'Klant'},{key:'omschrijving',label:'Opdracht'},{key:'partner',label:'Partner'},{key:'status',label:'Status'},{key:'honorarium',label:'Honorarium'},{key:'startdatum',label:'Startdatum'},{key:'einddatum',label:'Einddatum'},{key:'laatsteContact',label:'Laatste contact'},{key:'opmerking',label:'Opmerking'}];
const TABLE_LEADS_COLS=[{key:'klant',label:'Klant'},{key:'omschrijving',label:'Opdracht'},{key:'partner',label:'Partner'},{key:'status',label:'Status'},{key:'honorarium',label:'Honorarium'},{key:'verwacht',label:'Gewogen'},{key:'laatsteContact',label:'Laatste contact'},{key:'volgendeContact',label:'Volgende contact'},{key:'opmerking',label:'Opmerking'}];

const GRAPH_CONFIG={clientId:'cdc27541-133d-48b6-87b3-31daf4540b6d',tenantId:'cdf9d3c0-44dc-4ad3-aac0-33ee899e0e50',siteHost:'publicvalue.sharepoint.com',sitePath:'/sites/Algemeen',filePath:'/General/leadlijst.xlsx',sheetName:'Leads'};
let graphToken=null;let isOnline=false;let currentUserName='';
const REDIRECT_URI='https://publicvalue1.github.io/leadlijst/';
const AUTH_URL=`https://login.microsoftonline.com/${GRAPH_CONFIG.tenantId}/oauth2/v2.0/authorize`;
const SCOPES='Files.ReadWrite.All Sites.ReadWrite.All User.Read';

function checkForToken(){const hash=window.location.hash;if(hash&&hash.includes('access_token')){const params=new URLSearchParams(hash.substring(1));graphToken=params.get('access_token');isOnline=true;history.replaceState(null,'',window.location.pathname+window.location.search);return true;}try{const saved=sessionStorage.getItem('pv_graph_token');if(saved){const data=JSON.parse(saved);if(data.expires>Date.now()){graphToken=data.token;isOnline=true;return true;}}}catch(e){}return false;}
function saveToken(){try{sessionStorage.setItem('pv_graph_token',JSON.stringify({token:graphToken,expires:Date.now()+3500000}));}catch(e){}}
function doLogin(){const nonce=Math.random().toString(36).substring(2);const params=new URLSearchParams({client_id:GRAPH_CONFIG.clientId,response_type:'token',redirect_uri:REDIRECT_URI,scope:SCOPES,response_mode:'fragment',prompt:'select_account',nonce});window.location.href=AUTH_URL+'?'+params.toString();}

async function onLoginSuccess(){saveToken();document.getElementById('loginScreen').style.display='none';document.getElementById('mainApp').style.display='block';try{const resp=await graphFetch('https://graph.microsoft.com/v1.0/me');const me=await resp.json();currentUserName=me.displayName||me.userPrincipalName||'';document.getElementById('userName').textContent=currentUserName;}catch(e){}setSyncStatus('syncing','Laden vanuit SharePoint…');try{await loadFromSharePoint();populatePartnersFromData();setSyncStatus('online','Verbonden met SharePoint');}catch(err){console.error('Load from SP failed:',err);setSyncStatus('error','SharePoint laden mislukt: '+err.message);if(loadFromLocalStorage()){refreshAll();toast('⚠️ Offline modus — data uit cache');}}}

function populatePartnersFromData(){const partners=new Set();leads.forEach(l=>{if(l.partner)partners.add(l.partner);});if(partners.size===0)return;PARTNERS_DEFAULT.length=0;partners.forEach(p=>PARTNERS_DEFAULT.push(p));const sel=document.getElementById('fPartner');if(sel){sel.innerHTML='<option value="">— Kies —</option>';PARTNERS_DEFAULT.forEach(p=>{sel.innerHTML+=`<option value="${p}">${p}</option>`;});}}
function setSyncStatus(state,label){const el=document.getElementById('syncStatus');el.className='syncStatus '+state;document.getElementById('syncLabel').textContent=label;}

async function graphFetch(url,options={}){if(!graphToken)throw new Error('Niet ingelogd');const resp=await fetch(url,{...options,headers:{'Authorization':'Bearer '+graphToken,...(options.headers||{})}});if(resp.status===401){doLogin();throw new Error('Token verlopen');}if(!resp.ok){const txt=await resp.text();throw new Error(`Graph API ${resp.status}: ${txt}`);}return resp;}
let siteId=null,driveId=null,fileItemId=null;
async function resolveSiteAndFile(){if(siteId&&driveId&&fileItemId)return;const siteResp=await graphFetch(`https://graph.microsoft.com/v1.0/sites/${GRAPH_CONFIG.siteHost}:${GRAPH_CONFIG.sitePath}`);const siteData=await siteResp.json();siteId=siteData.id;const driveResp=await graphFetch(`https://graph.microsoft.com/v1.0/sites/${siteId}/drive`);const driveData=await driveResp.json();driveId=driveData.id;const fileResp=await graphFetch(`https://graph.microsoft.com/v1.0/drives/${driveId}/root:${GRAPH_CONFIG.filePath}`);const fileData=await fileResp.json();fileItemId=fileData.id;}

async function loadFromSharePoint(){setSyncStatus('syncing','Laden…');await resolveSiteAndFile();const dlResp=await graphFetch(`https://graph.microsoft.com/v1.0/drives/${driveId}/items/${fileItemId}/content`);const buf=await dlResp.arrayBuffer();const wb=XLSX.read(buf,{type:'array',cellDates:true});const ws=wb.Sheets[GRAPH_CONFIG.sheetName]||wb.Sheets[wb.SheetNames[0]];const rows=XLSX.utils.sheet_to_json(ws,{defval:''});leads=rows.map(parseRow).filter(r=>r.klant.trim()!=='');saveToLocalStorage();refreshAll();setSyncStatus('online','Verbonden — '+leads.length+' items');toast('☁ '+leads.length+' items geladen vanuit SharePoint');}

async function syncToSharePoint(){if(!isOnline){toast('⚠️ Niet verbonden met SharePoint');return;}setSyncStatus('syncing','Opslaan…');try{await resolveSiteAndFile();const rows=leads.map(leadToRow);const ws=XLSX.utils.json_to_sheet(rows);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,GRAPH_CONFIG.sheetName);const wbout=XLSX.write(wb,{type:'array',bookType:'xlsx'});await graphFetch(`https://graph.microsoft.com/v1.0/drives/${driveId}/items/${fileItemId}/content`,{method:'PUT',headers:{'Content-Type':'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'},body:wbout});saveToLocalStorage();setSyncStatus('online','Opgeslagen ✓');toast('☁ Opgeslagen naar SharePoint');}catch(err){console.error('Sync error:',err);setSyncStatus('error','Opslaan mislukt');toast('❌ Opslaan mislukt: '+err.message);}}

function leadToRow(l){return{'Klant':l.klant,'Bestaande klant / nieuwe klant':l.klantType,'Nieuwe opdracht / vervolgopdracht':l.opdrachtType,'Omschrijving opdracht':l.omschrijving,'Partner':l.partner,'Status':l.status,'Laatste keer contact':l.laatsteContact,'Eerstvolgende keer contact':l.volgendeContact,'Opmerking/follow-up':l.opmerking,'Startdatum':l.startdatum,'Einddatum':l.einddatum,'Honorarium':l.honorarium||'','Winkans':l.winkans,'Win/loss':l.winloss,'Verwachte omzet':l.verwacht};}
let syncTimeout=null;
function saveAndSync(){saveToLocalStorage();if(!isOnline)return;clearTimeout(syncTimeout);setSyncStatus('syncing','Wijzigingen opslaan…');syncTimeout=setTimeout(()=>syncToSharePoint(),2000);}
function saveToLocalStorage(){try{localStorage.setItem('pv_leads_v3',JSON.stringify(leads));}catch(e){}}
function loadFromLocalStorage(){try{const d=localStorage.getItem('pv_leads_v3');if(d){leads=JSON.parse(d);return true;}}catch(e){}return false;}

document.getElementById('fileInput').addEventListener('change',function(e){const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=function(ev){try{const wb=XLSX.read(ev.target.result,{type:'array',cellDates:true});const ws=wb.Sheets[wb.SheetNames[0]];const rows=XLSX.utils.sheet_to_json(ws,{defval:''});leads=rows.map(parseRow).filter(r=>r.klant.trim()!=='');saveToLocalStorage();document.getElementById('loginScreen').style.display='none';document.getElementById('mainApp').style.display='block';setSyncStatus('offline','Lokaal bestand');populatePartnersFromData();refreshAll();toast('✅ '+leads.length+' items geïmporteerd (lokaal)');}catch(err){toast('❌ Fout: '+err.message);}};reader.readAsArrayBuffer(file);e.target.value='';});

function parseRow(r){const g=(keys)=>{for(const k of keys){if(r[k]!==undefined&&r[k]!=='')return r[k];}return '';};const hon=parseFloat(g(['Honorarium']))||0;const status=String(g(['Status'])||'');const wl=String(g(['Win/loss','Win/Loss'])||'');const winkans=wl==='Win'?1:(STATUS_WINKANS[status]||0);const verwacht=wl==='Win'?hon:hon*winkans;return{klant:String(g(['Klant'])),klantType:String(g(['Bestaande klant / nieuwe klant'])),opdrachtType:String(g(['Nieuwe opdracht / vervolgopdracht'])),omschrijving:String(g(['Omschrijving opdracht'])),partner:String(g(['Partner'])),status,laatsteContact:fmtDate(g(['Laatste keer contact'])),volgendeContact:fmtDate(g(['Eerstvolgende keer contact'])),opmerking:String(g(['Opmerking/follow-up'])),startdatum:fmtDate(g(['Startdatum'])),einddatum:fmtDate(g(['Einddatum'])),honorarium:hon,winkans,winloss:wl,verwacht};}

function fmtDate(v){if(!v)return '';if(v instanceof Date){const y=v.getFullYear(),m=String(v.getMonth()+1).padStart(2,'0'),d=String(v.getDate()).padStart(2,'0');return`${y}-${m}-${d}`;}const s=String(v);if(s.match(/^\d{4}-\d{2}-\d{2}/))return s.split('T')[0].split(' ')[0];return s;}
function fmtDateNL(d){if(!d)return'—';const dt=new Date(d);return dt.toLocaleDateString('nl-NL',{day:'numeric',month:'short',year:'numeric'});}
function fmtEuro(v){if(!v&&v!==0)return'—';return'€ '+Math.round(v).toLocaleString('nl-NL');}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function statusPill(s){if(!s)return'<span class="statusPill" style="opacity:.3;">—</span>';const num=s.charAt(0);const short=STATUS_SHORT[s]||s;return`<span class="statusPill status-${num}">${short}</span>`;}
function getContactClass(vc){if(!vc)return'';const today=new Date();today.setHours(0,0,0,0);const d=new Date(vc);d.setHours(0,0,0,0);const diff=Math.round((d-today)/(864e5));if(diff<0)return'color:var(--pv-red);font-weight:700;';if(diff===0)return'color:var(--pv-blue);font-weight:700;';if(diff<=7)return'color:var(--pv-orange);font-weight:700;';return'';}

function exportToExcel(){if(!leads.length){toast('Geen data');return;}const rows=leads.map(leadToRow);const ws=XLSX.utils.json_to_sheet(rows);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Leads');XLSX.writeFile(wb,new Date().toISOString().split('T')[0].replace(/-/g,'')+'_Leadlijst_Public_Value.xlsx');toast('📥 Excel geëxporteerd');}

function refreshAll(){const has=leads.length>0;document.getElementById('emptyState').style.display=has?'none':'block';document.getElementById('dashboardContent').style.display=has?'block':'none';if(!has){document.getElementById('badgeCount').textContent='—';return;}document.getElementById('subtitleDate').textContent='Laatste update: '+new Date().toLocaleDateString('nl-NL',{day:'numeric',month:'long',year:'numeric'});const wins=leads.filter(l=>l.winloss==='Win');const pipeline=leads.filter(l=>l.winloss!=='Win'&&l.winloss!=='Loss'&&l.winloss!=='Afgerond');document.getElementById('badgeCount').textContent=wins.length+' opdrachten · '+pipeline.length+' leads';updatePartnerFilters();renderKPIs();renderAlerts();renderTimeline();renderFunnel();renderPartnerLeadsChart();renderPartnerWinsChart();renderClientWinsChart();renderClientLeadsChart();renderWinsTable();renderLeadsTable();renderCompleted();renderLosses();}

function renderKPIs(){const wins=leads.filter(l=>l.winloss==='Win');const pipeline=leads.filter(l=>l.winloss!=='Win'&&l.winloss!=='Loss'&&l.winloss!=='Afgerond');
  const today=new Date();today.setHours(0,0,0,0);
  // Calculate remaining confirmed revenue (from today onwards)
  let confirmedRemaining=0;let confirmedTotal=0;
  wins.forEach(l=>{confirmedTotal+=l.honorarium;const start=l.startdatum?new Date(l.startdatum):null;const end=l.einddatum?new Date(l.einddatum):null;if(start&&end&&end>=start){const totalDays=Math.max((end-start)/(864e5)+1,1);const effectiveStart=start<today?today:start;if(effectiveStart>end){confirmedRemaining+=0;}else{const remainDays=(end-effectiveStart)/(864e5)+1;confirmedRemaining+=l.honorarium*(remainDays/totalDays);}}else{confirmedRemaining+=l.honorarium;}});
  const pipelineHon=pipeline.reduce((s,l)=>s+l.honorarium,0);const weightedRev=pipeline.reduce((s,l)=>s+l.verwacht,0);
  document.getElementById('kpiWins').textContent=wins.length;document.getElementById('kpiWinsSub').textContent=fmtEuro(confirmedTotal)+' totale omzet';
  document.getElementById('kpiLeads').textContent=pipeline.length;document.getElementById('kpiLeadsSub').textContent='verdeeld over '+[...new Set(pipeline.map(l=>l.partner).filter(Boolean))].length+' partners';
  document.getElementById('kpiConfirmed').textContent=fmtEuro(Math.round(confirmedRemaining));document.getElementById('kpiConfirmedSub').textContent='resterend vanaf vandaag (totaal: '+fmtEuro(confirmedTotal)+')';
  document.getElementById('kpiWeighted').textContent=fmtEuro(Math.round(confirmedRemaining)+weightedRev);document.getElementById('kpiWeightedSub').textContent='bevestigd (resterend) + pipeline gewogen';
  document.getElementById('kpiPotential').textContent=fmtEuro(Math.round(confirmedRemaining)+pipelineHon);document.getElementById('kpiPotentialSub').textContent='als alles gewonnen wordt';}

let actionPartnerFilter='';

function renderAlerts(){
  const today=new Date();today.setHours(0,0,0,0);
  
  // Build partner filter pills
  const allPartners=[...new Set(leads.map(l=>l.partner).filter(Boolean))].sort();
  const pfRow=document.getElementById('partnerFilterRow');
  pfRow.innerHTML='<label style="margin-right:4px;">Partner:</label><span class="partnerPill'+(actionPartnerFilter===''?' active':'')+'" onclick="setActionPartner(\'\')">Iedereen</span>';
  allPartners.forEach(p=>{pfRow.innerHTML+=`<span class="partnerPill${actionPartnerFilter===p?' active':''}" onclick="setActionPartner('${esc(p)}')">${esc(p)}</span>`;});

  // 1. Contact alerts (verlopen/vandaag/komende week)
  const contactAlerts=[];
  leads.forEach((l,idx)=>{if(l.winloss==='Win'||l.winloss==='Loss'||l.winloss==='Afgerond')return;if(!l.volgendeContact)return;if(actionPartnerFilter&&l.partner!==actionPartnerFilter)return;const d=new Date(l.volgendeContact);d.setHours(0,0,0,0);const diff=Math.round((d-today)/864e5);let type,label;if(diff<0){type='overdue';label=Math.abs(diff)+' dag'+(Math.abs(diff)!==1?'en':'')+' verlopen';}else if(diff===0){type='today';label='Vandaag';}else if(diff<=7){type='upcoming';label='Over '+diff+' dag'+(diff!==1?'en':'');}else return;contactAlerts.push({idx,lead:l,type,label,diff,date:l.volgendeContact});});
  contactAlerts.sort((a,b)=>a.diff-b.diff);

  // 2. Expiring contracts (Win with einddatum within 30 days)
  const expiringAlerts=[];
  leads.forEach((l,idx)=>{if(l.winloss!=='Win')return;if(!l.einddatum)return;if(actionPartnerFilter&&l.partner!==actionPartnerFilter)return;const d=new Date(l.einddatum);d.setHours(0,0,0,0);const diff=Math.round((d-today)/864e5);if(diff<0){expiringAlerts.push({idx,lead:l,type:'overdue',label:Math.abs(diff)+' dag'+(Math.abs(diff)!==1?'en':'')+' verlopen',diff,date:l.einddatum});}else if(diff<=30){let label;if(diff===0)label='Vandaag';else label='Over '+diff+' dag'+(diff!==1?'en':'');expiringAlerts.push({idx,lead:l,type:diff<=7?'today':'upcoming',label,diff,date:l.einddatum});}});
  expiringAlerts.sort((a,b)=>a.diff-b.diff);

  // 3. Leads with past or upcoming startdatum (all past + 30 days ahead)
  const upcomingLeads=[];
  leads.forEach((l,idx)=>{if(l.winloss==='Win'||l.winloss==='Loss'||l.winloss==='Afgerond')return;if(!l.startdatum)return;if(actionPartnerFilter&&l.partner!==actionPartnerFilter)return;const d=new Date(l.startdatum);d.setHours(0,0,0,0);const diff=Math.round((d-today)/864e5);if(diff<0){upcomingLeads.push({idx,lead:l,type:'overdue',label:Math.abs(diff)+' dag'+(Math.abs(diff)!==1?'en':'')+' geleden',diff,date:l.startdatum});}else if(diff<=30){let label;if(diff===0)label='Vandaag';else label='Over '+diff+' dag'+(diff!==1?'en':'');upcomingLeads.push({idx,lead:l,type:diff<=7?'today':'upcoming',label,diff,date:l.startdatum});}});
  upcomingLeads.sort((a,b)=>a.diff-b.diff);

  // 4. Incomplete data: only when there's an imbalance or offerte stage
  const incompleteAlerts=[];
  leads.forEach((l,idx)=>{if(l.winloss==='Loss'||l.winloss==='Afgerond')return;if(actionPartnerFilter&&l.partner!==actionPartnerFilter)return;const issues=[];const isWin=l.winloss==='Win';const hasDates=l.startdatum||l.einddatum;const hasAmount=l.honorarium&&l.honorarium>0;const isOfferte=l.status&&(l.status.startsWith('3 -')||l.status.startsWith('4 -'));
  // Case 1: has dates but no amount
  if(hasDates&&!hasAmount)issues.push('geen tarief');
  // Case 2: has amount but no dates
  if(hasAmount&&!hasDates){if(!l.startdatum)issues.push('geen startdatum');if(!l.einddatum)issues.push('geen einddatum');}
  // Case 3: offerte uitgebracht but missing key info
  if(isOfferte&&!hasAmount)issues.push('geen tarief');
  if(isOfferte&&!hasDates){if(!l.startdatum)issues.push('geen startdatum');if(!l.einddatum)issues.push('geen einddatum');}
  // Deduplicate
  const unique=[...new Set(issues)];
  if(unique.length>0){incompleteAlerts.push({idx,lead:l,issues:unique,isWin});}});

  // Update note
  const totalActions=contactAlerts.length+expiringAlerts.length+upcomingLeads.length+incompleteAlerts.length;
  const note=document.getElementById('alertNote');
  const parts=[];
  if(contactAlerts.length)parts.push(contactAlerts.length+' contact');
  if(expiringAlerts.length)parts.push(expiringAlerts.length+' aflopend');
  if(upcomingLeads.length)parts.push(upcomingLeads.length+' naderend');
  if(incompleteAlerts.length)parts.push(incompleteAlerts.length+' onvolledig');
  note.textContent=parts.length?parts.join(' · ')+(actionPartnerFilter?' — '+actionPartnerFilter:''):'Geen acties';

  // Render contact alerts
  const contactSection=document.getElementById('alertContactSection');
  const alertList=document.getElementById('alertList');
  if(contactAlerts.length){contactSection.style.display='block';alertList.innerHTML=contactAlerts.map(a=>`<div class="alertItem ${a.type}" onclick="openDetail(${a.idx})"><div class="alertDot ${a.type}"></div><div class="alertName">${esc(a.lead.klant)}${a.lead.omschrijving?' — '+esc(a.lead.omschrijving):''}<div class="alertPartner">${esc(a.lead.partner||'')}</div></div><div class="alertMeta">${fmtDateNL(a.date)}</div><span class="alertBadge ${a.type}">${a.label}</span></div>`).join('');}else{contactSection.style.display='none';}

  // Render expiring contracts
  const expiringSection=document.getElementById('alertExpiringSection');
  const expiringList=document.getElementById('expiringList');
  if(expiringAlerts.length){expiringSection.style.display='block';expiringList.innerHTML=expiringAlerts.map(a=>`<div class="alertItem expiring" onclick="openDetail(${a.idx})"><div class="alertDot expiring"></div><div class="alertName">${esc(a.lead.klant)}${a.lead.omschrijving?' — '+esc(a.lead.omschrijving):''}<div class="alertPartner">${esc(a.lead.partner||'')} · ${fmtEuro(a.lead.honorarium)}</div></div><div class="alertMeta">Einddatum: ${fmtDateNL(a.date)}</div><span class="alertBadge expiring">${a.label}</span></div>`).join('');}else{expiringSection.style.display='none';}

  // Render upcoming leads
  const upcomingSection=document.getElementById('alertUpcomingLeadsSection');
  const upcomingList=document.getElementById('upcomingLeadsList');
  if(upcomingLeads.length){upcomingSection.style.display='block';upcomingList.innerHTML=upcomingLeads.map(a=>`<div class="alertItem upcominglead" onclick="openDetail(${a.idx})"><div class="alertDot upcominglead"></div><div class="alertName">${esc(a.lead.klant)}${a.lead.omschrijving?' — '+esc(a.lead.omschrijving):''}<div class="alertPartner">${esc(a.lead.partner||'')} · ${statusPill(a.lead.status)} · ${fmtEuro(a.lead.honorarium)}</div></div><div class="alertMeta">Startdatum: ${fmtDateNL(a.date)}</div><span class="alertBadge upcominglead">${a.label}</span></div>`).join('');}else{upcomingSection.style.display='none';}

  // Render incomplete data
  const incompleteSection=document.getElementById('alertIncompleteSection');
  const incompleteList=document.getElementById('incompleteList');
  if(incompleteAlerts.length){incompleteSection.style.display='block';incompleteList.innerHTML=incompleteAlerts.map(a=>{const issueText=a.issues.join(', ');const hint=a.issues.includes('geen tarief')?'Vul bij benadering in':'Vul datum(s) in';return`<div class="alertItem incomplete" onclick="openDetail(${a.idx})"><div class="alertDot incomplete"></div><div class="alertName">${esc(a.lead.klant)}${a.lead.omschrijving?' — '+esc(a.lead.omschrijving):''}<div class="alertPartner">${esc(a.lead.partner||'')} · ${a.isWin?'Lopende opdracht':'Lead'}</div></div><div class="alertMeta" style="text-align:right;"><div style="color:var(--pv-orange);font-weight:700;font-size:12px;">${issueText}</div><div style="font-size:10px;opacity:.6;">${hint}</div></div></div>`;}).join('');}else{incompleteSection.style.display='none';}

  // Show empty state
  document.getElementById('alertEmpty').style.display=totalActions===0?'block':'none';
}

function setActionPartner(p){actionPartnerFilter=p;renderAlerts();}

function addNewPartner(){const name=prompt('Naam van de nieuwe partner:');if(!name||!name.trim())return;const trimmed=name.trim();if(!PARTNERS_DEFAULT.includes(trimmed)){PARTNERS_DEFAULT.push(trimmed);PARTNERS_DEFAULT.sort();}const sel=document.getElementById('fPartner');sel.innerHTML='<option value="">— Kies —</option>';PARTNERS_DEFAULT.forEach(p=>{sel.innerHTML+=`<option value="${p}">${p}</option>`;});sel.value=trimmed;toast('✅ Partner "'+trimmed+'" toegevoegd');}

const INFO_TEXTS={
  contact:{title:'Contactmomenten',text:'Leads waarvan het eerstvolgende contactmoment verlopen is, vandaag is, of binnen 7 dagen valt. Klik op een item om de details te bekijken en bij te werken.'},
  expiring:{title:'Aflopende opdrachten',text:'Lopende opdrachten (Win) waarvan de einddatum binnen 30 dagen valt of al verlopen is. Dit zijn opdrachten waarvoor mogelijk verlenging of een vervolgopdracht nodig is.'},
  upcoming:{title:'Leads — startdatum bereikt of naderend',text:'Leads in de pipeline waarvan de startdatum al verstreken is of binnen 30 dagen valt. Leads met een verlopen startdatum vereisen actie: win markeren, startdatum bijwerken, of als loss afsluiten.'},
  incomplete:{title:'Onvolledige gegevens',text:'Items waarbij gegevens niet kloppen: een tarief zonder datum(s), datum(s) zonder tarief, of een uitgebrachte offerte (status 3/4) waar nog essentiële info mist. Zonder beide kan een item niet in de omzetprognose verschijnen. Vul bij benadering in als het exacte bedrag of de exacte datum nog niet bekend is.'},
  kpi_opdrachten:{title:'Lopende opdrachten',text:'Alle opdrachten met status "Win". Dit zijn bevestigde opdrachten die momenteel lopen. Het aantal toont hoeveel actieve opdrachten er zijn, met daaronder de totale contractwaarde.'},
  kpi_leads:{title:'Leads in pipeline',text:'Alle leads die nog open staan (niet gewonnen, verloren of afgerond). Dit zijn potentiële opdrachten in verschillende stadia van het salesproces.'},
  kpi_bevestigd:{title:'Bevestigde omzet (resterend)',text:'De resterende omzet van lopende opdrachten, berekend vanaf vandaag. Als een opdracht van €120.000 loopt van jan t/m dec en we zijn halverwege februari, dan telt alleen de resterende omzet pro-rata mee. Opdrachten zonder datum tellen volledig mee.'},
  kpi_gewogen:{title:'Gewogen omzet',text:'De optelsom van: resterende bevestigde omzet (100%) + pipeline-leads gewogen naar winkans. Status 1 = 10%, status 2 = 25%, offerte in concurrentie = 40%, offerte zonder concurrentie = 70%. Dit geeft het meest realistische beeld van de verwachte omzet.'},
  kpi_potentieel:{title:'Potentiële omzet',text:'De optelsom van: resterende bevestigde omzet + het volledige bedrag van alle pipeline-leads (100%, ongeacht winkans). Dit is het maximale scenario als alle leads gewonnen worden.'}
};
function showInfo(type){const info=INFO_TEXTS[type];if(!info)return;const overlay=document.createElement('div');overlay.className='infoPopupOverlay';const popup=document.createElement('div');popup.className='infoPopup';popup.innerHTML=`<h4>${info.title}</h4><p>${info.text}</p><div style="text-align:right;margin-top:12px;"><button onclick="this.closest('.infoPopup').remove();document.querySelector('.infoPopupOverlay').remove();" class="primary" style="padding:8px 18px;">Begrepen</button></div>`;document.body.appendChild(overlay);document.body.appendChild(popup);overlay.onclick=()=>{popup.remove();overlay.remove();};}


/* Timeline */
function getMonthlyRevenue(){const now=new Date();const currentY=now.getFullYear();const currentM=now.getMonth();const months=[];for(let i=0;i<12;i++){let m=currentM+i;let y=currentY;if(m>=12){m-=12;y++;}months.push({month:m,year:y,confirmed:0,pipeline:0,potential:0,leads:[]});}const ym=(y,m)=>y*12+m;const firstYM=ym(months[0].year,months[0].month);const lastYM=ym(months[11].year,months[11].month);leads.forEach(l=>{if(!l.honorarium||l.honorarium<=0||l.winloss==='Loss'||l.winloss==='Afgerond')return;const isWin=l.winloss==='Win';const start=l.startdatum?new Date(l.startdatum):null;const end=l.einddatum?new Date(l.einddatum):null;if(start&&end&&end>=start){const startY=start.getFullYear(),startM=start.getMonth();const endY=end.getFullYear(),endM=end.getMonth();const totalMonths=(endY-startY)*12+(endM-startM)+1;const monthlyHon=l.honorarium/totalMonths;const monthlyVerwacht=l.verwacht/totalMonths;for(let i=0;i<totalMonths;i++){const mIdx=startM+i;const my=startY+Math.floor(mIdx/12);const mm=mIdx%12;const thisYM=ym(my,mm);if(thisYM<firstYM||thisYM>lastYM)continue;const slot=months.find(s=>s.year===my&&s.month===mm);if(slot){if(isWin){slot.confirmed+=monthlyHon;slot.leads.push({name:l.klant,omschrijving:l.omschrijving,amount:monthlyHon,amountPotential:monthlyHon,isWin,idx:leads.indexOf(l)});}else{slot.pipeline+=monthlyVerwacht;slot.potential+=monthlyHon;slot.leads.push({name:l.klant,omschrijving:l.omschrijving,amount:monthlyVerwacht,amountPotential:monthlyHon,isWin,idx:leads.indexOf(l)});}}}}else if(start){const sYM=ym(start.getFullYear(),start.getMonth());if(sYM>=firstYM&&sYM<=lastYM){const slot=months.find(s=>s.year===start.getFullYear()&&s.month===start.getMonth());if(slot){if(isWin){slot.confirmed+=l.honorarium;slot.leads.push({name:l.klant,omschrijving:l.omschrijving,amount:l.honorarium,amountPotential:l.honorarium,isWin,idx:leads.indexOf(l)});}else{slot.pipeline+=l.verwacht;slot.potential+=l.honorarium;slot.leads.push({name:l.klant,omschrijving:l.omschrijving,amount:l.verwacht,amountPotential:l.honorarium,isWin,idx:leads.indexOf(l)});}}}}});return months;}

function toggleTimelineFilter(type){if(type==='confirmed')showConfirmed=!showConfirmed;if(type==='pipeline')showPipeline=!showPipeline;if(type==='potential')showPotential=!showPotential;document.getElementById('toggleConfirmed').classList.toggle('active',showConfirmed);document.getElementById('togglePipeline').classList.toggle('active',showPipeline);document.getElementById('togglePotential').classList.toggle('active',showPotential);renderTimeline();}

function renderTimeline(){cachedMonths=getMonthlyRevenue();const months=cachedMonths;const wrap=document.getElementById('timelineWrap');const now=new Date();const currentM=now.getMonth();const currentY=now.getFullYear();const getVal=m=>{let v=0;if(showConfirmed)v+=m.confirmed;if(showPotential)v+=m.potential;else if(showPipeline)v+=m.pipeline;return v;};const maxVal=Math.max(...months.map(getVal),1);wrap.innerHTML=months.map((m,i)=>{const confirmed=showConfirmed?m.confirmed:0;const pipeline=showPipeline&&!showPotential?m.pipeline:0;const potential=showPotential?m.potential:0;const barTop=Math.max(pipeline,potential);const total=confirmed+barTop;const confirmedPct=confirmed>0?(confirmed/maxVal*100):0;const pipelinePct=(confirmed+pipeline)>0?((confirmed+pipeline)/maxVal*100):0;const potentialPct=(confirmed+potential)>0?((confirmed+potential)/maxVal*100):0;const isCurrent=m.month===currentM&&m.year===currentY;const subText=(confirmed>0&&barTop>0)?`<span class="sub">${fmtEuro(confirmed)} bevestigd</span>`:'';return`<div class="timelineMonth ${isCurrent?'currentMonth':''}" onclick="openMonthDetail(${i})"><div class="timelineMonthLabel">${MONTH_NAMES[m.month]}<span class="year">${m.year}</span></div><div class="timelineBarOuter">${showPotential&&potential>0?`<div class="timelineBarInner potential" style="width:${Math.max(potentialPct,2)}%;left:0;"></div>`:''}${showPipeline&&!showPotential&&pipeline>0?`<div class="timelineBarInner pipeline" style="width:${Math.max(pipelinePct,2)}%;left:0;"></div>`:''}${showConfirmed&&confirmed>0?`<div class="timelineBarInner confirmed" style="width:${Math.max(confirmedPct,2)}%;">${confirmedPct>15?fmtEuro(confirmed):''}</div>`:''}</div><div class="timelineAmount">${total>0?fmtEuro(total):'<span style="opacity:.3;">—</span>'}${subText}</div></div>`;}).join('');}

/* Month Detail Modal with filters */
function openMonthDetail(idx){currentMonthModalIdx=idx;mmShowConfirmed=showConfirmed;mmShowPipeline=showPipeline;mmShowPotential=showPotential;document.getElementById('mmToggleConfirmed').classList.toggle('active',mmShowConfirmed);document.getElementById('mmTogglePipeline').classList.toggle('active',mmShowPipeline);document.getElementById('mmTogglePotential').classList.toggle('active',mmShowPotential);renderMonthModalContent();document.getElementById('monthModalOverlay').classList.add('active');}
function toggleMonthFilter(type){if(type==='confirmed')mmShowConfirmed=!mmShowConfirmed;if(type==='pipeline')mmShowPipeline=!mmShowPipeline;if(type==='potential')mmShowPotential=!mmShowPotential;document.getElementById('mmToggleConfirmed').classList.toggle('active',mmShowConfirmed);document.getElementById('mmTogglePipeline').classList.toggle('active',mmShowPipeline);document.getElementById('mmTogglePotential').classList.toggle('active',mmShowPotential);renderMonthModalContent();}
function renderMonthModalContent(){const idx=currentMonthModalIdx;const m=cachedMonths[idx];if(!m)return;document.getElementById('monthModalTitle').textContent=MONTH_NAMES[m.month]+' '+m.year;document.getElementById('mmConfirmed').textContent=fmtEuro(m.confirmed);document.getElementById('mmPipeline').textContent=fmtEuro(m.pipeline);document.getElementById('mmPotential').textContent=fmtEuro(m.potential);const filtered=m.leads.filter(l=>{if(l.isWin&&mmShowConfirmed)return true;if(!l.isWin&&mmShowPipeline&&!mmShowPotential)return true;if(!l.isWin&&mmShowPotential)return true;return false;});let totalShown=0;filtered.forEach(l=>{if(l.isWin)totalShown+=l.amount;else if(mmShowPotential)totalShown+=l.amountPotential;else totalShown+=l.amount;});document.getElementById('mmTotal').textContent=fmtEuro(totalShown);const body=document.getElementById('monthModalBody');if(!filtered.length){body.innerHTML='<tr><td colspan="4" style="text-align:center;color:var(--text-soft);padding:24px;">Geen opdrachten voor deze selectie</td></tr>';}else{body.innerHTML=filtered.map(l=>{const displayAmount=l.isWin?l.amount:(mmShowPotential?l.amountPotential:l.amount);return`<tr onclick="closeMonthModal();openDetail(${l.idx})"><td style="font-weight:700;">${esc(l.name)}</td><td style="color:var(--text-soft);">${esc(l.omschrijving||'')}</td><td>${l.isWin?'<span class="statusPill winloss-win">Lopend</span>':'<span class="statusPill status-2" style="font-size:10px;">Pipeline</span>'}</td><td style="text-align:right;font-weight:700;font-variant-numeric:tabular-nums;">${fmtEuro(displayAmount)}</td></tr>`;}).join('');}}
function closeMonthModal(){document.getElementById('monthModalOverlay').classList.remove('active');}

/* Funnel clickable */
function renderFunnel(){const wrap=document.getElementById('funnelWrap');const pipeline=leads.filter(l=>l.winloss!=='Win'&&l.winloss!=='Loss'&&l.winloss!=='Afgerond'&&l.winloss!=='Afgerond');const stages=Object.keys(STATUS_COLORS);const data=stages.map(s=>{const items=pipeline.filter(l=>l.status===s);return{status:s,count:items.length,value:items.reduce((sum,l)=>sum+l.honorarium,0)};});const maxCount=Math.max(...data.map(d=>d.count),1);wrap.innerHTML=data.map(d=>{const pct=Math.max(d.count/maxCount*100,8);const c=STATUS_COLORS[d.status];const short=STATUS_SHORT[d.status]||d.status;return`<div class="funnelStep" onclick="openFunnelDetail('${d.status}')"><div class="funnelLabel">${short}</div><div class="funnelBar" style="width:${pct}%;background:${c.bg};color:${c.text};">${d.count}</div><div class="funnelValue">${fmtEuro(d.value)}</div></div>`;}).join('');}
function openFunnelDetail(status){const pipeline=leads.filter(l=>l.winloss!=='Win'&&l.winloss!=='Loss'&&l.winloss!=='Afgerond'&&l.status===status);const short=STATUS_SHORT[status]||status;const totalVal=pipeline.reduce((s,l)=>s+l.honorarium,0);openChartDetailModal(short,pipeline,totalVal,'Potentieel');}

/* Charts with click handlers */
let chartPartnerLeads=null,chartPartnerWins=null,chartClientWins=null,chartClientLeads=null;

function renderPartnerLeadsChart(){const ctx=document.getElementById('partnerLeadsChart').getContext('2d');if(chartPartnerLeads)chartPartnerLeads.destroy();const pipeline=leads.filter(l=>l.winloss!=='Win'&&l.winloss!=='Loss'&&l.winloss!=='Afgerond');const partners={};pipeline.forEach(l=>{if(!l.partner)return;if(!partners[l.partner])partners[l.partner]={count:0,value:0,items:[]};partners[l.partner].count++;partners[l.partner].value+=l.honorarium;partners[l.partner].items.push(l);});const sorted=Object.entries(partners).sort((a,b)=>b[1].count-a[1].count);chartPartnerLeads=new Chart(ctx,{type:'bar',data:{labels:sorted.map(s=>s[0]),datasets:[{label:'Aantal leads',data:sorted.map(s=>s[1].count),backgroundColor:COLORS.slice(0,sorted.length).map(c=>c+'cc'),borderColor:COLORS.slice(0,sorted.length),borderWidth:1,borderRadius:8}]},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',onClick:(e,elements)=>{if(elements.length>0){const idx=elements[0].index;const d=sorted[idx];openChartDetailModal('Leads — '+d[0],d[1].items,d[1].value,'Potentieel');}},plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>{const d=sorted[ctx.dataIndex][1];return d.count+' leads · '+fmtEuro(d.value)+' potentieel';}}}},scales:{x:{grid:{color:'rgba(255,255,255,.06)'},ticks:{color:'#cfe6de',stepSize:1}},y:{grid:{display:false},ticks:{color:'#fff',font:{weight:700}}}}}});}

function renderPartnerWinsChart(){const ctx=document.getElementById('partnerWinsChart').getContext('2d');if(chartPartnerWins)chartPartnerWins.destroy();const wins=leads.filter(l=>l.winloss==='Win');const partners={};wins.forEach(l=>{if(!l.partner)return;if(!partners[l.partner])partners[l.partner]={count:0,value:0,items:[]};partners[l.partner].count++;partners[l.partner].value+=l.honorarium;partners[l.partner].items.push(l);});const sorted=Object.entries(partners).sort((a,b)=>b[1].value-a[1].value);if(!sorted.length){chartPartnerWins=new Chart(ctx,{type:'bar',data:{labels:['Geen data'],datasets:[{data:[0],backgroundColor:'rgba(255,255,255,.05)'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{display:false},y:{display:false}}}});return;}chartPartnerWins=new Chart(ctx,{type:'bar',data:{labels:sorted.map(s=>s[0]),datasets:[{label:'Omzet',data:sorted.map(s=>s[1].value),backgroundColor:sorted.map((_,i)=>COLORS[i%COLORS.length]+'cc'),borderColor:sorted.map((_,i)=>COLORS[i%COLORS.length]),borderWidth:1,borderRadius:8}]},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',onClick:(e,elements)=>{if(elements.length>0){const idx=elements[0].index;const d=sorted[idx];openChartDetailModal('Opdrachten — '+d[0],d[1].items,d[1].value,'Omzet');}},plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>{const d=sorted[ctx.dataIndex][1];return d.count+' opdrachten · '+fmtEuro(d.value);}}}},scales:{x:{grid:{color:'rgba(255,255,255,.06)'},ticks:{color:'#cfe6de',callback:v=>fmtEuro(v)}},y:{grid:{display:false},ticks:{color:'#fff',font:{weight:700}}}}}});}

function renderClientWinsChart(){const ctx=document.getElementById('clientWinsChart').getContext('2d');if(chartClientWins)chartClientWins.destroy();const wins=leads.filter(l=>l.winloss==='Win');const clients={};wins.forEach(l=>{if(!l.klant)return;if(!clients[l.klant])clients[l.klant]={value:0,items:[]};clients[l.klant].value+=l.honorarium;clients[l.klant].items.push(l);});const sorted=Object.entries(clients).filter(c=>c[1].value>0).sort((a,b)=>b[1].value-a[1].value).slice(0,10);if(!sorted.length){chartClientWins=new Chart(ctx,{type:'bar',data:{labels:['Geen data'],datasets:[{data:[0],backgroundColor:'rgba(255,255,255,.05)'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{display:false},y:{display:false}}}});return;}chartClientWins=new Chart(ctx,{type:'bar',data:{labels:sorted.map(s=>s[0].length>28?s[0].slice(0,26)+'…':s[0]),datasets:[{label:'Omzet',data:sorted.map(s=>s[1].value),backgroundColor:COLORS.map(c=>c+'aa'),borderColor:COLORS,borderWidth:1,borderRadius:8}]},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',onClick:(e,elements)=>{if(elements.length>0){const idx=elements[0].index;const d=sorted[idx];openChartDetailModal(d[0]+' — Opdrachten',d[1].items,d[1].value,'Omzet');}},plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>fmtEuro(ctx.raw)}}},scales:{x:{grid:{color:'rgba(255,255,255,.06)'},ticks:{color:'#cfe6de',callback:v=>fmtEuro(v)}},y:{grid:{display:false},ticks:{color:'#fff',font:{weight:600,size:11}}}}}});}

function renderClientLeadsChart(){const ctx=document.getElementById('clientLeadsChart').getContext('2d');if(chartClientLeads)chartClientLeads.destroy();const pipeline=leads.filter(l=>l.winloss!=='Win'&&l.winloss!=='Loss'&&l.winloss!=='Afgerond');const clients={};pipeline.forEach(l=>{if(!l.klant)return;if(!clients[l.klant])clients[l.klant]={value:0,items:[]};clients[l.klant].value+=l.honorarium;clients[l.klant].items.push(l);});const sorted=Object.entries(clients).filter(c=>c[1].value>0).sort((a,b)=>b[1].value-a[1].value).slice(0,10);if(!sorted.length){chartClientLeads=new Chart(ctx,{type:'bar',data:{labels:['Geen data'],datasets:[{data:[0],backgroundColor:'rgba(255,255,255,.05)'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{display:false},y:{display:false}}}});return;}chartClientLeads=new Chart(ctx,{type:'bar',data:{labels:sorted.map(s=>s[0].length>28?s[0].slice(0,26)+'…':s[0]),datasets:[{label:'Potentieel',data:sorted.map(s=>s[1].value),backgroundColor:COLORS.map(c=>c+'77'),borderColor:COLORS,borderWidth:1,borderRadius:8}]},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',onClick:(e,elements)=>{if(elements.length>0){const idx=elements[0].index;const d=sorted[idx];openChartDetailModal(d[0]+' — Leads',d[1].items,d[1].value,'Potentieel');}},plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>fmtEuro(ctx.raw)}}},scales:{x:{grid:{color:'rgba(255,255,255,.06)'},ticks:{color:'#cfe6de',callback:v=>fmtEuro(v)}},y:{grid:{display:false},ticks:{color:'#fff',font:{weight:600,size:11}}}}}});}

/* Generic Chart Detail Modal */
function openChartDetailModal(title,items,totalVal,totalLabel){document.getElementById('chartDetailTitle').textContent=title;document.getElementById('cdTotal').textContent=fmtEuro(totalVal);document.getElementById('cdTotalLabel').textContent=totalLabel;document.getElementById('cdCount').textContent=items.length;const isWinView=items.length>0&&items[0].winloss==='Win';document.getElementById('chartDetailHead').innerHTML='<th>Klant</th><th>Opdracht</th><th>Partner</th><th>Status</th><th style="text-align:right;">Honorarium</th>'+(isWinView?'<th>Periode</th>':'<th style="text-align:right;">Gewogen</th>');document.getElementById('chartDetailBody').innerHTML=items.map(l=>{const idx=leads.indexOf(l);const periode=l.startdatum&&l.einddatum?fmtDateNL(l.startdatum)+' — '+fmtDateNL(l.einddatum):(l.startdatum?'Vanaf '+fmtDateNL(l.startdatum):'—');return`<tr onclick="closeChartDetail();openDetail(${idx})"><td style="font-weight:700;">${esc(l.klant)}</td><td style="color:var(--text-soft);">${esc(l.omschrijving||'')}</td><td>${esc(l.partner||'')}</td><td>${l.winloss==='Win'?'<span class="statusPill winloss-win">Lopend</span>':statusPill(l.status)}</td><td style="text-align:right;font-weight:700;font-variant-numeric:tabular-nums;">${fmtEuro(l.honorarium)}</td>${isWinView?`<td style="font-size:12px;color:var(--text-soft);">${periode}</td>`:`<td style="text-align:right;font-variant-numeric:tabular-nums;color:var(--text-soft);">${fmtEuro(l.verwacht)}</td>`}</tr>`;}).join('');document.getElementById('chartDetailOverlay').classList.add('active');}
function closeChartDetail(){document.getElementById('chartDetailOverlay').classList.remove('active');}

/* Tables */
let sortWinsCol=-1,sortWinsAsc=true,sortLeadsCol=-1,sortLeadsAsc=true;
function updatePartnerFilters(){const partners=[...new Set(leads.map(l=>l.partner).filter(Boolean))].sort();['filterPartnerWins','filterPartnerLeads'].forEach(id=>{const sel=document.getElementById(id);if(!sel)return;const cur=sel.value;sel.innerHTML='<option value="">Alle partners</option>'+partners.map(p=>'<option value="'+p+'">'+p+'</option>').join('');sel.value=cur;});}

function renderWinsTable(){const partner=document.getElementById('filterPartnerWins').value;const search=document.getElementById('searchWins').value.toLowerCase();const wins=leads.filter(l=>{if(l.winloss!=='Win')return false;if(partner&&l.partner!==partner)return false;if(search&&!(l.klant.toLowerCase().includes(search)||l.omschrijving.toLowerCase().includes(search)))return false;return true;});document.getElementById('tableWinsCount').textContent=wins.length+' opdrachten · '+fmtEuro(wins.reduce((s,l)=>s+l.honorarium,0));const head=document.getElementById('tableWinsHead');head.innerHTML=TABLE_WINS_COLS.map((c,i)=>{const s=sortWinsCol===i;const arrow=s?(sortWinsAsc?'▲':'▼'):'⇅';return`<th class="${s?'sorted':''}" onclick="sortWinsCol=${i};sortWinsAsc=${sortWinsCol===i?!sortWinsAsc:true};renderWinsTable()">${c.label} <span class="sortArrow">${arrow}</span></th>`;}).join('');let sorted=[...wins];if(sortWinsCol>=0){const key=TABLE_WINS_COLS[sortWinsCol].key;sorted.sort((a,b)=>{let va=a[key],vb=b[key];if(typeof va==='number'&&typeof vb==='number')return sortWinsAsc?va-vb:vb-va;va=String(va||'').toLowerCase();vb=String(vb||'').toLowerCase();return sortWinsAsc?va.localeCompare(vb):vb.localeCompare(va);});}document.getElementById('tableWinsBody').innerHTML=sorted.map(l=>{const idx=leads.indexOf(l);return`<tr onclick="openDetail(${idx})"><td style="font-weight:700;">${esc(l.klant)}</td><td>${esc(l.omschrijving)}</td><td>${esc(l.partner)}</td><td>${statusPill(l.status)}</td><td style="text-align:right;font-variant-numeric:tabular-nums;font-weight:700;">${l.honorarium?fmtEuro(l.honorarium):'—'}</td><td style="font-size:12px;">${l.startdatum?fmtDateNL(l.startdatum):'—'}</td><td style="font-size:12px;">${l.einddatum?fmtDateNL(l.einddatum):'—'}</td><td style="font-size:12px;">${l.laatsteContact?fmtDateNL(l.laatsteContact):'—'}</td><td style="font-size:12px;color:var(--text-soft);max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${esc(l.opmerking)}">${esc(l.opmerking)}</td></tr>`;}).join('');}

function renderLeadsTable(){const status=document.getElementById('filterStatusLeads').value;const partner=document.getElementById('filterPartnerLeads').value;const search=document.getElementById('searchLeads').value.toLowerCase();const pipeline=leads.filter(l=>{if(l.winloss==='Win'||l.winloss==='Loss'||l.winloss==='Afgerond')return false;if(status&&l.status!==status)return false;if(partner&&l.partner!==partner)return false;if(search&&!(l.klant.toLowerCase().includes(search)||l.omschrijving.toLowerCase().includes(search)))return false;return true;});document.getElementById('tableLeadsCount').textContent=pipeline.length+' leads · '+fmtEuro(pipeline.reduce((s,l)=>s+l.honorarium,0))+' potentieel';const head=document.getElementById('tableLeadsHead');head.innerHTML=TABLE_LEADS_COLS.map((c,i)=>{const s=sortLeadsCol===i;const arrow=s?(sortLeadsAsc?'▲':'▼'):'⇅';return`<th class="${s?'sorted':''}" onclick="sortLeadsCol=${i};sortLeadsAsc=${sortLeadsCol===i?!sortLeadsAsc:true};renderLeadsTable()">${c.label} <span class="sortArrow">${arrow}</span></th>`;}).join('');let sorted=[...pipeline];if(sortLeadsCol>=0){const key=TABLE_LEADS_COLS[sortLeadsCol].key;sorted.sort((a,b)=>{let va=a[key],vb=b[key];if(typeof va==='number'&&typeof vb==='number')return sortLeadsAsc?va-vb:vb-va;va=String(va||'').toLowerCase();vb=String(vb||'').toLowerCase();return sortLeadsAsc?va.localeCompare(vb):vb.localeCompare(va);});}document.getElementById('tableLeadsBody').innerHTML=sorted.map(l=>{const idx=leads.indexOf(l);const contactClass=getContactClass(l.volgendeContact);return`<tr onclick="openDetail(${idx})"><td style="font-weight:700;">${esc(l.klant)}</td><td>${esc(l.omschrijving)}</td><td>${esc(l.partner)}</td><td>${statusPill(l.status)}</td><td style="text-align:right;font-variant-numeric:tabular-nums;font-weight:700;">${l.honorarium?fmtEuro(l.honorarium):'—'}</td><td style="text-align:right;font-variant-numeric:tabular-nums;color:var(--text-soft);">${l.verwacht?fmtEuro(l.verwacht):'—'}</td><td style="font-size:12px;">${l.laatsteContact?fmtDateNL(l.laatsteContact):'—'}</td><td style="font-size:12px;${contactClass}">${l.volgendeContact?fmtDateNL(l.volgendeContact):'—'}</td><td style="font-size:12px;color:var(--text-soft);max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${esc(l.opmerking)}">${esc(l.opmerking)}</td></tr>`;}).join('');}

/* KPI Detail Modal */
function openKpiModal(type){
  const today=new Date();today.setHours(0,0,0,0);
  function calcRemaining(l){const start=l.startdatum?new Date(l.startdatum):null;const end=l.einddatum?new Date(l.einddatum):null;if(start&&end&&end>=start){const totalDays=Math.max((end-start)/(864e5)+1,1);const effectiveStart=start<today?today:start;if(effectiveStart>end)return 0;const remainDays=(end-effectiveStart)/(864e5)+1;return l.honorarium*(remainDays/totalDays);}return l.honorarium;}

  if(type==='opdrachten'){
    const items=leads.filter(l=>l.winloss==='Win');
    const totalRemaining=Math.round(items.reduce((s,l)=>s+calcRemaining(l),0));
    const totalFull=items.reduce((s,l)=>s+l.honorarium,0);
    document.getElementById('kpiModalTitle').textContent='Lopende Opdrachten';
    document.getElementById('kmTotal').textContent=fmtEuro(totalRemaining);
    document.getElementById('kmTotalLabel').textContent='Resterend';
    document.getElementById('kmCount').textContent=items.length;
    document.getElementById('kpiModalHead').innerHTML='<th>Klant</th><th>Opdracht</th><th>Partner</th><th style="text-align:right;">Totaal</th><th style="text-align:right;">Resterend</th><th>Periode</th>';
    document.getElementById('kpiModalBody').innerHTML=items.sort((a,b)=>calcRemaining(b)-calcRemaining(a)).map(l=>{
      const idx=leads.indexOf(l);const rem=Math.round(calcRemaining(l));
      const periode=l.startdatum&&l.einddatum?fmtDateNL(l.startdatum)+' — '+fmtDateNL(l.einddatum):(l.startdatum?'Vanaf '+fmtDateNL(l.startdatum):'—');
      return`<tr onclick="closeKpiModal();openDetail(${idx})"><td style="font-weight:700;">${esc(l.klant)}</td><td style="color:var(--text-soft);">${esc(l.omschrijving||'')}</td><td>${esc(l.partner||'')}</td><td style="text-align:right;font-variant-numeric:tabular-nums;color:var(--text-soft);">${fmtEuro(l.honorarium)}</td><td style="text-align:right;font-weight:700;font-variant-numeric:tabular-nums;">${fmtEuro(rem)}</td><td style="font-size:12px;color:var(--text-soft);white-space:nowrap;">${periode}</td></tr>`;
    }).join('');
    document.getElementById('kpiModalOverlay').classList.add('active');return;
  }

  // For leads/bevestigd/gewogen/potentieel - build with filters
  let title='',totalLabel='Omzet';
  let allItems=[],calcVal=l=>0;

  if(type==='leads'){
    title='Leads in Pipeline';totalLabel='Potentieel';
    allItems=leads.filter(l=>l.winloss!=='Win'&&l.winloss!=='Loss'&&l.winloss!=='Afgerond');
    calcVal=l=>l.honorarium;
  }else if(type==='bevestigd'){
    title='Bevestigde Omzet (resterend)';totalLabel='Resterend';
    allItems=leads.filter(l=>l.winloss==='Win');
    calcVal=l=>Math.round(calcRemaining(l));
  }else if(type==='gewogen'){
    title='Gewogen Omzet';totalLabel='Gewogen';
    allItems=[...leads.filter(l=>l.winloss==='Win').map(l=>({...l,_type:'win',_val:Math.round(calcRemaining(l)),_pot:l.honorarium})),...leads.filter(l=>l.winloss!=='Win'&&l.winloss!=='Loss'&&l.winloss!=='Afgerond').map(l=>({...l,_type:'lead',_val:l.verwacht,_pot:l.honorarium}))];
    calcVal=l=>l._val!==undefined?l._val:l.verwacht;
  }else if(type==='potentieel'){
    title='Potentiële Omzet';totalLabel='Potentieel';
    allItems=[...leads.filter(l=>l.winloss==='Win').map(l=>({...l,_type:'win',_val:Math.round(calcRemaining(l)),_pot:l.honorarium})),...leads.filter(l=>l.winloss!=='Win'&&l.winloss!=='Loss'&&l.winloss!=='Afgerond').map(l=>({...l,_type:'lead',_val:l.honorarium,_pot:l.honorarium}))];
    calcVal=l=>l._val!==undefined?l._val:l.honorarium;
  }

  // Build partner filter
  const partners=[...new Set(allItems.map(l=>l.partner).filter(Boolean))].sort();
  let filterPartner='';let filterHideZero=true;
  let kpiSortKey='_value';let kpiSortAsc=false;

  // Define columns per type
  let columns=[];
  if(type==='opdrachten'||type==='bevestigd'){
    columns=[{key:'klant',label:'Klant',align:'left'},{key:'omschrijving',label:'Opdracht',align:'left'},{key:'partner',label:'Partner',align:'left'},{key:'honorarium',label:'Totaal',align:'right',numeric:true},{key:'_remaining',label:'Resterend',align:'right',numeric:true},{key:'_periode',label:'Periode',align:'left'}];
  }else if(type==='leads'){
    columns=[{key:'klant',label:'Klant',align:'left'},{key:'omschrijving',label:'Opdracht',align:'left'},{key:'partner',label:'Partner',align:'left'},{key:'status',label:'Status',align:'left'},{key:'honorarium',label:'Potentieel',align:'right',numeric:true},{key:'verwacht',label:'Gewogen',align:'right',numeric:true}];
  }else{
    columns=[{key:'klant',label:'Klant',align:'left'},{key:'omschrijving',label:'Opdracht',align:'left'},{key:'partner',label:'Partner',align:'left'},{key:'_typeLabel',label:'Type',align:'left'},{key:'_value',label:'Waarde',align:'right',numeric:true}];
  }

  function getKpiSortVal(l,key){
    if(key==='_value')return calcVal(l);
    if(key==='_remaining')return Math.round(calcRemaining(l));
    if(key==='_typeLabel')return l._type==='win'?'0':'1'+(l.status||'');
    if(key==='_periode')return l.startdatum||'';
    const v=l[key];return v===undefined?'':v;
  }

  function renderKpiModalContent(){
    let filtered=allItems;
    if(filterPartner)filtered=filtered.filter(l=>l.partner===filterPartner);
    if(filterHideZero)filtered=filtered.filter(l=>calcVal(l)>0);

    // Sort
    filtered=[...filtered];
    filtered.sort((a,b)=>{
      let va=getKpiSortVal(a,kpiSortKey),vb=getKpiSortVal(b,kpiSortKey);
      if(typeof va==='number'&&typeof vb==='number')return kpiSortAsc?va-vb:vb-va;
      va=String(va||'').toLowerCase();vb=String(vb||'').toLowerCase();
      return kpiSortAsc?va.localeCompare(vb):vb.localeCompare(va);
    });

    const totalVal=filtered.reduce((s,l)=>s+calcVal(l),0);
    document.getElementById('kpiModalTitle').textContent=title;
    document.getElementById('kmTotal').textContent=fmtEuro(Math.round(totalVal));
    document.getElementById('kmTotalLabel').textContent=totalLabel;
    document.getElementById('kmCount').textContent=filtered.length;

    // Sortable headers
    const headHtml=columns.map(c=>{
      const isSorted=kpiSortKey===c.key;
      const arrow=isSorted?(kpiSortAsc?'▲':'▼'):'⇅';
      const align=c.align==='right'?'text-align:right;':'';
      return`<th class="kpiSortTh${isSorted?' sorted':''}" data-sortkey="${c.key}" style="${align}cursor:pointer;">${c.label} <span class="sortArrow">${arrow}</span></th>`;
    }).join('');

    // Filters row
    let filtersHtml='<div class="modalFilterRow"><span class="modalFilterToggle kpiPartnerBtn'+(filterPartner===''?' active':'')+'" data-partner="">Iedereen</span>';
    partners.forEach(p=>{filtersHtml+=`<span class="modalFilterToggle kpiPartnerBtn${filterPartner===p?' active':''}" data-partner="${esc(p)}">${esc(p)}</span>`;});
    filtersHtml+=`<span style="margin-left:auto;" class="modalFilterToggle kpiZeroBtn${filterHideZero?' active':''}">Verberg € 0</span></div>`;

    document.getElementById('kpiModalHead').innerHTML=headHtml;
    let existingFilters=document.getElementById('kpiFilterRow');
    if(!existingFilters){existingFilters=document.createElement('div');existingFilters.id='kpiFilterRow';document.getElementById('kpiModalHead').closest('table').parentNode.insertBefore(existingFilters,document.getElementById('kpiModalHead').closest('table'));}
    existingFilters.innerHTML=filtersHtml;

    // Bind filter clicks
    existingFilters.querySelectorAll('.kpiPartnerBtn').forEach(btn=>{btn.addEventListener('click',()=>{filterPartner=btn.dataset.partner;renderKpiModalContent();});});
    existingFilters.querySelector('.kpiZeroBtn').addEventListener('click',()=>{filterHideZero=!filterHideZero;renderKpiModalContent();});

    // Bind sort clicks
    document.querySelectorAll('#kpiModalHead .kpiSortTh').forEach(th=>{th.addEventListener('click',()=>{const key=th.dataset.sortkey;if(kpiSortKey===key)kpiSortAsc=!kpiSortAsc;else{kpiSortKey=key;kpiSortAsc=columns.find(c=>c.key===key)?.numeric?false:true;}renderKpiModalContent();});});

    document.getElementById('kpiModalBody').innerHTML=filtered.map(l=>{
      const origIdx=leads.indexOf(l);const idx=origIdx>=0?origIdx:leads.findIndex(o=>o.klant===l.klant&&o.omschrijving===l.omschrijving);
      if(type==='opdrachten'||type==='bevestigd'){
        const rem=Math.round(calcRemaining(l));
        const periode=l.startdatum&&l.einddatum?fmtDateNL(l.startdatum)+' — '+fmtDateNL(l.einddatum):(l.startdatum?'Vanaf '+fmtDateNL(l.startdatum):'—');
        return`<tr onclick="closeKpiModal();openDetail(${idx})"><td style="font-weight:700;">${esc(l.klant)}</td><td style="color:var(--text-soft);">${esc(l.omschrijving||'')}</td><td>${esc(l.partner||'')}</td><td style="text-align:right;font-variant-numeric:tabular-nums;color:var(--text-soft);">${fmtEuro(l.honorarium)}</td><td style="text-align:right;font-weight:700;font-variant-numeric:tabular-nums;">${fmtEuro(rem)}</td><td style="font-size:12px;color:var(--text-soft);white-space:nowrap;">${periode}</td></tr>`;
      }else if(type==='leads'){
        return`<tr onclick="closeKpiModal();openDetail(${idx})"><td style="font-weight:700;">${esc(l.klant)}</td><td style="color:var(--text-soft);">${esc(l.omschrijving||'')}</td><td>${esc(l.partner||'')}</td><td>${statusPill(l.status)}</td><td style="text-align:right;font-variant-numeric:tabular-nums;color:var(--text-soft);">${fmtEuro(l.honorarium)}</td><td style="text-align:right;font-weight:700;font-variant-numeric:tabular-nums;">${fmtEuro(l.verwacht)}</td></tr>`;
      }else{
        const typeLabel=l._type==='win'?'<span class="statusPill winloss-win">Lopend</span>':statusPill(l.status);
        return`<tr onclick="closeKpiModal();openDetail(${idx})"><td style="font-weight:700;">${esc(l.klant)}</td><td style="color:var(--text-soft);">${esc(l.omschrijving||'')}</td><td>${esc(l.partner||'')}</td><td>${typeLabel}</td><td style="text-align:right;font-weight:700;font-variant-numeric:tabular-nums;">${fmtEuro(calcVal(l))}</td></tr>`;
      }
    }).join('');
  }

  renderKpiModalContent();
  document.getElementById('kpiModalOverlay').classList.add('active');
}
function closeKpiModal(){document.getElementById('kpiModalOverlay').classList.remove('active');const fr=document.getElementById('kpiFilterRow');if(fr)fr.remove();}

/* Lead detail modal */
function openDetail(idx){const l=leads[idx];if(!l)return;document.getElementById('detailTitle').textContent=l.klant;const isWin=l.winloss==='Win';const grid=document.getElementById('detailGrid');grid.innerHTML=`<div class="detailField"><div class="detailLabel">Type</div><div class="detailValue">${isWin?'<span class="statusPill winloss-win">Lopende opdracht</span>':l.winloss==='Afgerond'?'<span class="statusPill winloss-afgerond">Afgerond</span>':l.winloss==='Loss'?'<span class="statusPill winloss-loss">Loss</span>':'<span style="color:var(--pv-orange);">Lead in pipeline</span>'}</div></div><div class="detailField"><div class="detailLabel">Partner</div><div class="detailValue">${esc(l.partner)||'—'}</div></div><div class="detailField full"><div class="detailLabel">Omschrijving</div><div class="detailValue">${esc(l.omschrijving)||'—'}</div></div><div class="detailDivider"></div><div class="detailField"><div class="detailLabel">Status</div><div class="detailValue">${statusPill(l.status)}</div></div><div class="detailField"><div class="detailLabel">Honorarium</div><div class="detailValue" style="font-size:18px;font-weight:900;">${l.honorarium?fmtEuro(l.honorarium):'—'}</div></div><div class="detailField"><div class="detailLabel">Gewogen omzet</div><div class="detailValue">${l.verwacht?fmtEuro(l.verwacht):'—'}</div></div><div class="detailField"><div class="detailLabel">Winkans</div><div class="detailValue">${Math.round(l.winkans*100)}%</div></div><div class="detailDivider"></div><div class="detailField"><div class="detailLabel">Startdatum</div><div class="detailValue">${l.startdatum?fmtDateNL(l.startdatum):'—'}</div></div><div class="detailField"><div class="detailLabel">Einddatum</div><div class="detailValue">${l.einddatum?fmtDateNL(l.einddatum):'—'}</div></div><div class="detailField"><div class="detailLabel">Laatste contact</div><div class="detailValue">${l.laatsteContact?fmtDateNL(l.laatsteContact):'—'}</div></div><div class="detailField"><div class="detailLabel">Eerstvolgende contact</div><div class="detailValue" style="${getContactClass(l.volgendeContact)}">${l.volgendeContact?fmtDateNL(l.volgendeContact):'—'}</div></div>${l.klantType?`<div class="detailField"><div class="detailLabel">Klanttype</div><div class="detailValue">${esc(l.klantType)}</div></div>`:''}${l.opdrachtType?`<div class="detailField"><div class="detailLabel">Opdrachttype</div><div class="detailValue">${esc(l.opdrachtType)}</div></div>`:''}${l.opmerking?`<div class="detailDivider"></div><div class="detailField full"><div class="detailLabel">Opmerking / follow-up</div><div class="detailValue" style="color:var(--text-soft);font-size:13px;line-height:1.5;">${esc(l.opmerking)}</div></div>`:''}`;document.getElementById('detailEditBtn').onclick=()=>{closeDetail();openEditModal(idx);};const lossBtn=document.getElementById('detailLossBtn');const winBtn=document.getElementById('detailWinBtn');winBtn.style.display='none';if(l.winloss==='Loss'){lossBtn.style.display='inline-flex';lossBtn.textContent='↩ Terugzetten als lead';lossBtn.className='primary';lossBtn.onclick=()=>{restoreLead(idx);};}else if(l.winloss==='Afgerond'){lossBtn.style.display='inline-flex';lossBtn.textContent='↩ Heropen als opdracht';lossBtn.className='primary';lossBtn.onclick=()=>{reopenAsWin(idx);closeDetail();};}else if(isWin){lossBtn.style.display='inline-flex';lossBtn.textContent='✓ Opdracht afronden';lossBtn.className='primary';lossBtn.onclick=()=>{markAsCompleted(idx);};}else{lossBtn.style.display='inline-flex';lossBtn.textContent='✗ Markeer als Loss';lossBtn.className='danger';lossBtn.onclick=()=>{markAsLoss(idx);};winBtn.style.display='inline-flex';winBtn.onclick=()=>{markAsWin(idx);};}document.getElementById('detailOverlay').classList.add('active');}
function closeDetail(){document.getElementById('detailOverlay').classList.remove('active');}

/* Add/Edit modal */
function openAddModal(){editIndex=-1;document.getElementById('modalTitle').textContent='Nieuwe lead toevoegen';document.getElementById('btnDeleteLead').style.display='none';clearForm();document.getElementById('modalOverlay').classList.add('active');}
function openEditModal(idx){editIndex=idx;const l=leads[idx];document.getElementById('modalTitle').textContent='Bewerken — '+l.klant;document.getElementById('btnDeleteLead').style.display='inline-flex';document.getElementById('fKlant').value=l.klant;document.getElementById('fOmschrijving').value=l.omschrijving;const fp=document.getElementById('fPartner');ensureOpt(fp,l.partner);fp.value=l.partner;document.getElementById('fStatus').value=l.status;document.getElementById('fWinLoss').value=l.winloss||'';document.getElementById('fStart').value=l.startdatum;document.getElementById('fEind').value=l.einddatum;document.getElementById('fHonorarium').value=l.honorarium||'';document.getElementById('fKlantType').value=l.klantType||'';document.getElementById('fLaatsteContact').value=l.laatsteContact||'';document.getElementById('fVolgendeContact').value=l.volgendeContact||'';document.getElementById('fOpmerking').value=l.opmerking;document.getElementById('modalOverlay').classList.add('active');}
function ensureOpt(sel,val){if(!val)return;for(let o of sel.options)if(o.value===val)return;const opt=document.createElement('option');opt.value=val;opt.textContent=val;sel.appendChild(opt);}
function closeModal(){document.getElementById('modalOverlay').classList.remove('active');}
function clearForm(){['fKlant','fOmschrijving','fStart','fEind','fHonorarium','fOpmerking','fLaatsteContact','fVolgendeContact'].forEach(id=>document.getElementById(id).value='');document.getElementById('fStatus').value='1 - Geïdentificeerd';document.getElementById('fWinLoss').value='';document.getElementById('fKlantType').value='';}
function saveLead(){const klant=document.getElementById('fKlant').value.trim();if(!klant){toast('⚠️ Vul een klantnaam in');return;}const status=document.getElementById('fStatus').value;const wl=document.getElementById('fWinLoss').value;const hon=parseFloat(document.getElementById('fHonorarium').value)||0;const winkans=wl==='Win'?1:(STATUS_WINKANS[status]||0);const verwacht=wl==='Win'?hon:hon*winkans;const lead={klant,klantType:document.getElementById('fKlantType').value,opdrachtType:editIndex>=0?leads[editIndex].opdrachtType:'',omschrijving:document.getElementById('fOmschrijving').value,partner:document.getElementById('fPartner').value,status,laatsteContact:document.getElementById('fLaatsteContact').value,volgendeContact:document.getElementById('fVolgendeContact').value,opmerking:document.getElementById('fOpmerking').value,startdatum:document.getElementById('fStart').value,einddatum:document.getElementById('fEind').value,honorarium:hon,winkans,winloss:wl,verwacht};if(editIndex>=0){leads[editIndex]=lead;toast('✅ Bijgewerkt');}else{leads.push(lead);toast('✅ Toegevoegd');}saveAndSync();closeModal();refreshAll();}
function deleteLead(){if(editIndex<0)return;if(!confirm('Weet je zeker dat je "'+leads[editIndex].klant+'" wilt verwijderen?'))return;leads.splice(editIndex,1);saveAndSync();closeModal();refreshAll();toast('🗑 Verwijderd');}
function markAsLoss(idx){const l=leads[idx];if(!confirm('Weet je zeker dat je "'+l.klant+(l.omschrijving?' — '+l.omschrijving:'')+'" als Loss wilt markeren?'))return;leads[idx].winloss='Loss';leads[idx].winkans=0;leads[idx].verwacht=0;saveAndSync();closeDetail();refreshAll();toast('✗ '+l.klant+' gemarkeerd als Loss');}
function markAsCompleted(idx){const l=leads[idx];if(!confirm('Opdracht "'+l.klant+(l.omschrijving?' — '+l.omschrijving:'')+'" afronden?'))return;leads[idx].winloss='Afgerond';saveAndSync();closeDetail();refreshAll();toast('✓ '+l.klant+' afgerond');}
function markAsWin(idx){const l=leads[idx];if(!confirm('"'+l.klant+(l.omschrijving?' — '+l.omschrijving:'')+'" markeren als gewonnen opdracht?'))return;leads[idx].winloss='Win';leads[idx].winkans=1;leads[idx].verwacht=leads[idx].honorarium;saveAndSync();closeDetail();refreshAll();toast('🏆 '+l.klant+' gewonnen!');}
function restoreLead(idx){const l=leads[idx];const winkans=STATUS_WINKANS[l.status]||0;leads[idx].winloss='';leads[idx].winkans=winkans;leads[idx].verwacht=l.honorarium*winkans;saveAndSync();closeDetail();refreshAll();toast('↩ '+l.klant+' teruggezet als lead');}
function renderCompleted(){const completed=leads.filter(l=>l.winloss==='Afgerond');const card=document.getElementById('completedCard');if(!completed.length){card.style.display='none';return;}card.style.display='block';document.getElementById('completedNote').textContent=completed.length+' afgeronde opdracht'+(completed.length!==1?'en':'')+' · '+fmtEuro(completed.reduce((s,l)=>s+l.honorarium,0));document.getElementById('completedBody').innerHTML=completed.map(l=>{const idx=leads.indexOf(l);const periode=l.startdatum&&l.einddatum?fmtDateNL(l.startdatum)+' — '+fmtDateNL(l.einddatum):(l.startdatum?'Vanaf '+fmtDateNL(l.startdatum):'—');return`<tr onclick="openDetail(${idx})"><td style="font-weight:700;opacity:.7;">${esc(l.klant)}</td><td style="color:var(--text-soft);opacity:.7;">${esc(l.omschrijving)||'—'}</td><td style="opacity:.7;">${esc(l.partner)||'—'}</td><td style="text-align:right;font-variant-numeric:tabular-nums;opacity:.7;">${l.honorarium?fmtEuro(l.honorarium):'—'}</td><td style="font-size:12px;color:var(--text-soft);opacity:.7;">${periode}</td><td style="font-size:12px;color:var(--text-soft);max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${esc(l.opmerking)||'—'}</td><td><button style="padding:5px 10px;font-size:11px;" onclick="event.stopPropagation();reopenAsWin(${idx})">↩ Heropen</button></td></tr>`;}).join('');}
function reopenAsWin(idx){leads[idx].winloss='Win';leads[idx].winkans=1;leads[idx].verwacht=leads[idx].honorarium;saveAndSync();refreshAll();toast('↩ '+leads[idx].klant+' heropend als lopende opdracht');}
function renderLosses(){const losses=leads.filter(l=>l.winloss==='Loss');const card=document.getElementById('lossCard');if(!losses.length){card.style.display='none';return;}card.style.display='block';document.getElementById('lossNote').textContent=losses.length+' verloren lead'+(losses.length!==1?'s':'');document.getElementById('lossBody').innerHTML=losses.map(l=>{const idx=leads.indexOf(l);return`<tr onclick="openDetail(${idx})"><td style="font-weight:700;opacity:.7;">${esc(l.klant)}</td><td style="color:var(--text-soft);opacity:.7;">${esc(l.omschrijving)||'—'}</td><td style="opacity:.7;">${esc(l.partner)||'—'}</td><td><span class="statusPill winloss-loss">Loss</span></td><td style="text-align:right;font-variant-numeric:tabular-nums;opacity:.7;">${l.honorarium?fmtEuro(l.honorarium):'—'}</td><td style="font-size:12px;color:var(--text-soft);max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${esc(l.opmerking)||'—'}</td><td><button style="padding:5px 10px;font-size:11px;" onclick="event.stopPropagation();restoreLead(${idx})">↩ Herstel</button></td></tr>`;}).join('');}
function toggleCollapse(contentId,arrowId){const c=document.getElementById(contentId);const a=document.getElementById(arrowId);if(c.classList.contains('collapsed')){c.classList.remove('collapsed');a.classList.remove('arrowUp');}else{c.classList.add('collapsed');a.classList.add('arrowUp');}}

function toast(msg){const el=document.getElementById('toast');el.textContent=msg;el.classList.add('show');clearTimeout(el._t);el._t=setTimeout(()=>el.classList.remove('show'),2800);}

/* Init */
if(checkForToken()){onLoginSuccess();}else{document.getElementById('loginScreen').style.display='flex';}

</script>
</body>
</html>
